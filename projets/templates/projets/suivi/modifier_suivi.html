<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Modifier le suivi – {{ projet.nom }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .suivi-card {
      border-radius: 12px;
      overflow: hidden;
    }
    .type-badge {
      font-size: 0.8em;
      padding: 5px 10px;
      border-radius: 20px;
    }
    .badge-importance-faible {
      background-color: #28a745;
    }
    .badge-importance-moyenne {
      background-color: #ffc107;
      color: #212529;
    }
    .badge-importance-elevee {
      background-color: #dc3545;
    }
    .fichier-item {
      border-left: 3px solid #0dcaf0;
      padding-left: 15px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    .fichier-item:hover {
      background-color: rgba(13, 202, 240, 0.1);
    }
  </style>
</head>
<body class="bg-dark text-light p-4" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">

  <!-- En-tête -->
  <div class="d-flex align-items-center mb-4 p-4 rounded shadow-lg" style="background: linear-gradient(135deg, #1e1e1e, #2b2b2b);">
    <h1 class="text-info mb-0"><i class="fa-solid fa-pen-to-square me-2"></i> Modifier le suivi</h1>
  </div>

  <!-- Boutons navigation -->
  <div class="mb-4 d-flex flex-wrap gap-3">
    <a href="{% url 'projets:suivi_execution' projet.id %}" class="btn btn-outline-info btn-lg px-4">
      <i class="fa-solid fa-arrow-left"></i> Retour au suivi
    </a>
    <a href="{% url 'projets:dashboard' projet.id %}" class="btn btn-outline-warning btn-lg px-4">
      <i class="fa-solid fa-diagram-project"></i> Tableau de bord
    </a>
  </div>

  <!-- Informations projet -->
  <div class="card bg-dark text-light p-4 mb-4 border-0 shadow-lg" style="border-radius: 12px;">
    <h2 class="card-title text-info mb-3">{{ projet.nom }}</h2>
    <div class="row">
      <div class="col-md-6">
        <p><strong>Numéro de marché :</strong> {{ projet.numero }}</p>
        <p><strong>Objet :</strong> {{ projet.objet }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Maître d'ouvrage :</strong> {{ projet.maitre_ouvrage }}</p>
        <p><strong>Statut :</strong> <span class="badge bg-secondary">{{ projet.get_statut_display }}</span></p>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Formulaire de modification -->
  <div class="card bg-dark text-light p-4 mb-4 border-0 shadow-lg" style="border-radius: 12px;">
    <h3 class="mb-3 text-info"><i class="fa-solid fa-edit me-2"></i> Modifier l'entrée de suivi</h3>
    
    <form method="post" class="mt-3">
      {% csrf_token %}
      
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control bg-secondary text-light" id="date" name="date" 
                 value="{{ suivi.date|date:'Y-m-d' }}" required>
        </div>
        
        <div class="col-md-4">
          <label for="type_suivi" class="form-label">Type de suivi</label>
          <select class="form-select bg-secondary text-light" id="type_suivi" name="type_suivi" required>
            <option value="reunion" {% if suivi.type_suivi == 'reunion' %}selected{% endif %}>Réunion de chantier</option>
            <option value="incident" {% if suivi.type_suivi == 'incident' %}selected{% endif %}>Incident</option>
            <option value="planning" {% if suivi.type_suivi == 'planning' %}selected{% endif %}>Mise à jour planning</option>
            <option value="livraison" {% if suivi.type_suivi == 'livraison' %}selected{% endif %}>Livraison</option>
            <option value="validation" {% if suivi.type_suivi == 'validation' %}selected{% endif %}>Validation d'étape</option>
            <option value="autre" {% if suivi.type_suivi == 'autre' %}selected{% endif %}>Autre</option>
          </select>
        </div>
        
        <div class="col-md-4">
          <label for="importance" class="form-label">Importance</label>
          <select class="form-select bg-secondary text-light" id="importance" name="importance">
            <option value="faible" {% if suivi.importance == 'faible' %}selected{% endif %}>Faible</option>
            <option value="moyenne" {% if suivi.importance == 'moyenne' or not suivi.importance %}selected{% endif %}>Moyenne</option>
            <option value="elevee" {% if suivi.importance == 'elevee' %}selected{% endif %}>Élevée</option>
          </select>
        </div>
      </div>
      
      <div class="mb-3">
        <label for="titre" class="form-label">Titre</label>
        <input type="text" class="form-control bg-secondary text-light" id="titre" name="titre" 
               value="{{ suivi.titre }}" placeholder="Ex: Réunion de coordination du 15/11/2023" required>
      </div>
      
      <div class="mb-3">
        <label for="commentaire" class="form-label">Commentaire ou résumé</label>
        <textarea class="form-control bg-secondary text-light" id="commentaire" name="commentaire" 
                  rows="6" placeholder="Détails de l'événement ou du suivi..." required>{{ suivi.commentaire }}</textarea>
      </div>
      
      <div class="mb-4">
        <label for="redacteur" class="form-label">Rédigé par</label>
        <input type="text" class="form-control bg-secondary text-light" id="redacteur" name="redacteur" 
               value="{{ suivi.redacteur }}" placeholder="Votre nom">
      </div>
      
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success btn-lg px-4">
          <i class="fa-solid fa-check me-2"></i> Enregistrer les modifications
        </button>
        <a href="{% url 'projets:suivi_execution' projet.id %}" class="btn btn-secondary btn-lg px-4">
          <i class="fa-solid fa-times me-2"></i> Annuler
        </a>
      </div>
    </form>
  </div>

  <!-- Section des fichiers joints -->
  <div class="card bg-dark text-light p-4 border-0 shadow-lg" style="border-radius: 12px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0 text-info"><i class="fa-solid fa-paperclip me-2"></i> Fichiers joints</h3>
      <a href="{% url 'projets:ajouter_fichiers_suivi' projet.id suivi.id %}" class="btn btn-primary btn-sm">
        <i class="fa-solid fa-plus me-1"></i> Ajouter des fichiers
      </a>
    </div>
    
    {% if suivi.fichiers.all %}
      <div class="row">
        {% for fichier in suivi.fichiers.all %}
          <div class="col-12 mb-3">
            <div class="fichier-item">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  {% with fichier.fichier.name|slice:"-4:"|lower as file_ext %}
                    {% if file_ext == '.pdf' %}
                      <i class="fa-solid fa-file-pdf text-danger me-3 fa-lg"></i>
                    {% elif file_ext == '.doc' or file_ext == 'docx' %}
                      <i class="fa-solid fa-file-word text-primary me-3 fa-lg"></i>
                    {% elif file_ext == '.xls' or file_ext == 'xlsx' %}
                      <i class="fa-solid fa-file-excel text-success me-3 fa-lg"></i>
                    {% elif file_ext == '.jpg' or file_ext == '.jpeg' or file_ext == '.png' or file_ext == '.gif' %}
                      <i class="fa-solid fa-file-image text-warning me-3 fa-lg"></i>
                    {% else %}
                      <i class="fa-solid fa-file text-info me-3 fa-lg"></i>
                    {% endif %}
                  {% endwith %}
                  
                  <div>
                    <div class="fw-bold">{{ fichier.fichier.name|truncatechars:40 }}</div>
                    {% if fichier.description %}
                      <small class="text-muted">{{ fichier.description }}</small>
                    {% endif %}
                    <div class="text-muted">
                      <small><i class="fa-solid fa-calendar me-1"></i> {{ fichier.date_ajout|date:"d/m/Y H:i" }}</small>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex gap-2">
                  <a href="{% url 'projets:afficher_fichier_suivi' fichier.id %}" 
                     target="_blank" class="btn btn-sm btn-info" title="Voir le fichier">
                    <i class="fa-solid fa-eye"></i>
                  </a>
                  <a href="{% url 'projets:afficher_fichier_suivi' fichier.id %}?download=true" 
                     class="btn btn-sm btn-success" title="Télécharger">
                    <i class="fa-solid fa-download"></i>
                  </a>
                  <form method="post" action="{% url 'projets:supprimer_fichier_suivi' fichier.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" 
                            onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce fichier?')" title="Supprimer">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-3">
        <i class="fa-solid fa-file-circle-question display-6 text-muted mb-2"></i>
        <p class="text-muted">Aucun fichier joint à ce suivi.</p>
      </div>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  
  <script>
    // Configuration du sélecteur de date
    flatpickr("#date", {
      locale: "fr",
      dateFormat: "Y-m-d",
      allowInput: true
    });

    // Prévisualisation du texte (nombre de caractères)
    const commentaireTextarea = document.getElementById('commentaire');
    const caractereCount = document.createElement('div');
    caractereCount.className = 'form-text text-end text-muted';
    commentaireTextarea.parentNode.appendChild(caractereCount);

    function updateCaractereCount() {
      const length = commentaireTextarea.value.length;
      caractereCount.textContent = `${length} caractères`;
      
      if (length > 1000) {
        caractereCount.classList.add('text-warning');
      } else {
        caractereCount.classList.remove('text-warning');
      }
    }

    commentaireTextarea.addEventListener('input', updateCaractereCount);
    updateCaractereCount(); // Initial count

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
      let isValid = true;
      const titre = document.getElementById('titre').value.trim();
      const commentaire = document.getElementById('commentaire').value.trim();
      
      if (!titre) {
        alert('Le titre est obligatoire');
        isValid = false;
      }
      
      if (!commentaire) {
        alert('Le commentaire est obligatoire');
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>