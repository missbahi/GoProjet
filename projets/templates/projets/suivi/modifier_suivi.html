<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier le suivi – {{ projet.nom }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { 
      background-color: #2E2E2E; 
      color: #AECBD6; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    .suivi-card {
      border-radius: 12px;
      overflow: hidden;
    }
    .type-badge {
      font-size: 0.8em;
      padding: 5px 10px;
      border-radius: 20px;
    }
    .badge-importance-faible {
      background-color: #28a745;
    }
    .badge-importance-moyenne {
      background-color: #ffc107;
      color: #212529;
    }
    .badge-importance-elevee {
      background-color: #dc3545;
    }
    .fichier-item {
      border-left: 3px solid #0dcaf0;
      padding-left: 15px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    .fichier-item:hover {
      background-color: rgba(13, 202, 240, 0.1);
    }
    
    /* Optimisations responsive */
    @media (max-width: 768px) {
      .btn-responsive {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
      .text-responsive {
        font-size: 0.875rem;
      }
      .flex-responsive {
        flex-direction: column;
        align-items: stretch;
      }
      .hidden-mobile {
        display: none;
      }
      .fichier-item {
        padding-left: 10px;
        margin-bottom: 8px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 0.5rem;
      }
      .btn-responsive {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }
      .text-xs-mobile {
        font-size: 0.75rem;
      }
      .card {
        margin-bottom: 1rem;
      }
    }
    
    /* Améliorations pour très grands écrans */
    @media (min-width: 1536px) {
      .container-xxl {
        max-width: 1400px;
      }
    }
    
    /* Styles personnalisés pour le dark theme */
    .bg-custom-dark {
      background: linear-gradient(135deg, #1e1e1e, #2b2b2b);
    }
    .form-control-custom {
      background-color: #2E2E2E;
      border: 1px solid #4B5563;
      color: #AECBD6;
    }
    .form-control-custom:focus {
      background-color: #2E2E2E;
      border-color: #0dcaf0;
      color: #AECBD6;
      box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
    }
    .form-select-custom {
      background-color: #2E2E2E;
      border: 1px solid #4B5563;
      color: #AECBD6;
    }
    .form-select-custom:focus {
      background-color: #2E2E2E;
      border-color: #0dcaf0;
      color: #AECBD6;
      box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
    }
  </style>
</head>
<body class="p-3 p-md-4">
  <div class="container-xxl">
    <!-- En-tête -->
    <div class="d-flex align-items-center mb-3 mb-md-4 p-3 p-md-4 rounded shadow-lg bg-custom-dark">
      <h1 class="text-info mb-0 h3 h-md-2">
        <i class="fa-solid fa-pen-to-square me-2"></i> Modifier le suivi
      </h1>
    </div>

    <!-- Boutons navigation -->
    <div class="mb-3 mb-md-4 d-flex flex-column flex-sm-row flex-wrap gap-2">
      <a href="{% url 'projets:suivi_execution' projet.id %}" class="btn btn-outline-info btn-responsive px-3 px-md-4">
        <i class="fa-solid fa-arrow-left me-1 me-md-2"></i> 
        <span class="d-none d-sm-inline">Retour au suivi</span>
        <span class="d-sm-none">Retour</span>
      </a>
      <a href="{% url 'projets:dashboard' projet.id %}" class="btn btn-outline-warning btn-responsive px-3 px-md-4">
        <i class="fa-solid fa-diagram-project me-1 me-md-2"></i> 
        <span class="d-none d-sm-inline">Tableau de bord</span>
        <span class="d-sm-none">Dashboard</span>
      </a>
    </div>

    <!-- Informations projet -->
    <div class="card bg-dark text-light p-3 p-md-4 mb-3 mb-md-4 border-0 shadow-lg" style="border-radius: 12px;">
      <h2 class="card-title text-info mb-2 mb-md-3 h4 h-md-3">{{ projet.nom }}</h2>
      <div class="row">
        <div class="col-md-6 mb-2 mb-md-0">
          <p class="mb-1 mb-md-2 text-responsive"><strong>Numéro de marché :</strong> {{ projet.numero }}</p>
          <p class="mb-1 mb-md-2 text-responsive"><strong>Objet :</strong> {{ projet.objet }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1 mb-md-2 text-responsive"><strong>Maître d'ouvrage :</strong> {{ projet.maitre_ouvrage }}</p>
          <p class="mb-1 mb-md-2 text-responsive">
            <strong>Statut :</strong> 
            <span class="badge bg-secondary">{{ projet.get_statut_display }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="mb-3 mb-md-4">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <span class="text-responsive">{{ message }}</span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Formulaire de modification -->
    <div class="card bg-dark text-light p-3 p-md-4 mb-3 mb-md-4 border-0 shadow-lg" style="border-radius: 12px;">
      <h3 class="mb-2 mb-md-3 text-info h5 h-md-4">
        <i class="fa-solid fa-edit me-2"></i> Modifier l'entrée de suivi
      </h3>
      
      <form method="post" class="mt-2 mt-md-3">
        {% csrf_token %}
        
        <div class="row mb-2 mb-md-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">
            <label for="date" class="form-label text-responsive">Date</label>
            <input type="date" class="form-control form-control-custom text-responsive" id="date" name="date" 
                   value="{{ suivi.date|date:'Y-m-d' }}" required>
          </div>
          
          <div class="col-12 col-md-4 mb-2 mb-md-0">
            <label for="type_suivi" class="form-label text-responsive">Type de suivi</label>
            <select class="form-select form-select-custom text-responsive" id="type_suivi" name="type_suivi" required>
              <option value="reunion" {% if suivi.type_suivi == 'reunion' %}selected{% endif %}>Réunion de chantier</option>
              <option value="incident" {% if suivi.type_suivi == 'incident' %}selected{% endif %}>Incident</option>
              <option value="planning" {% if suivi.type_suivi == 'planning' %}selected{% endif %}>Mise à jour planning</option>
              <option value="livraison" {% if suivi.type_suivi == 'livraison' %}selected{% endif %}>Livraison</option>
              <option value="validation" {% if suivi.type_suivi == 'validation' %}selected{% endif %}>Validation d'étape</option>
              <option value="autre" {% if suivi.type_suivi == 'autre' %}selected{% endif %}>Autre</option>
            </select>
          </div>
          
          <div class="col-12 col-md-4">
            <label for="importance" class="form-label text-responsive">Importance</label>
            <select class="form-select form-select-custom text-responsive" id="importance" name="importance">
              <option value="faible" {% if suivi.importance == 'faible' %}selected{% endif %}>Faible</option>
              <option value="moyenne" {% if suivi.importance == 'moyenne' or not suivi.importance %}selected{% endif %}>Moyenne</option>
              <option value="elevee" {% if suivi.importance == 'elevee' %}selected{% endif %}>Élevée</option>
            </select>
          </div>
        </div>
        
        <div class="mb-2 mb-md-3">
          <label for="titre" class="form-label text-responsive">Titre</label>
          <input type="text" class="form-control form-control-custom text-responsive" id="titre" name="titre" 
                 value="{{ suivi.titre }}" placeholder="Ex: Réunion de coordination du 15/11/2023" required>
        </div>
        
        <div class="mb-2 mb-md-3">
          <label for="commentaire" class="form-label text-responsive">Commentaire ou résumé</label>
          <textarea class="form-control form-control-custom text-responsive" id="commentaire" name="commentaire" 
                    rows="5" placeholder="Détails de l'événement ou du suivi..." required>{{ suivi.commentaire }}</textarea>
          <div id="caractere-count" class="form-text text-end text-muted text-responsive"></div>
        </div>
        
        <div class="mb-3 mb-md-4">
          <label for="redacteur" class="form-label text-responsive">Rédigé par</label>
          <input type="text" class="form-control form-control-custom text-responsive" id="redacteur" name="redacteur" 
                 value="{{ suivi.redacteur }}" placeholder="Votre nom">
        </div>
        
        <div class="d-flex flex-column flex-sm-row gap-2">
          <button type="submit" class="btn btn-success btn-responsive px-3 px-md-4 order-2 order-sm-1">
            <i class="fa-solid fa-check me-1 me-md-2"></i> 
            <span class="d-none d-sm-inline">Enregistrer les modifications</span>
            <span class="d-sm-none">Enregistrer</span>
          </button>
          <a href="{% url 'projets:suivi_execution' projet.id %}" class="btn btn-secondary btn-responsive px-3 px-md-4 order-1 order-sm-2">
            <i class="fa-solid fa-times me-1 me-md-2"></i> 
            <span class="d-none d-sm-inline">Annuler</span>
            <span class="d-sm-none">Annuler</span>
          </a>
        </div>
      </form>
    </div>

    <!-- Section des fichiers joints -->
    <div class="card bg-dark text-light p-3 p-md-4 border-0 shadow-lg" style="border-radius: 12px;">
      <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 mb-3 mb-md-4">
        <h3 class="mb-0 text-info h5 h-md-4">
          <i class="fa-solid fa-paperclip me-2"></i> Fichiers joints
        </h3>
        <a href="{% url 'projets:ajouter_fichier_suivi' projet.id suivi.id %}" class="btn btn-primary btn-sm btn-responsive">
          <i class="fa-solid fa-plus me-1"></i> 
          <span class="d-none d-sm-inline">Ajouter des fichiers</span>
          <span class="d-sm-none">Ajouter</span>
        </a>
      </div>
      
      {% if suivi.fichiers.all %}
        <div class="row">
          {% for fichier in suivi.fichiers.all %}
            <div class="col-12 mb-2 mb-md-3">
              <div class="fichier-item">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                  <div class="d-flex align-items-start align-items-md-center flex-grow-1 min-w-0">
                    {% with fichier.fichier.name|slice:"-4:"|lower as file_ext %}
                      {% if file_ext == '.pdf' %}
                        <i class="fa-solid fa-file-pdf text-danger me-2 me-md-3 fa-lg flex-shrink-0 mt-1 mt-md-0"></i>
                      {% elif file_ext == '.doc' or file_ext == 'docx' %}
                        <i class="fa-solid fa-file-word text-primary me-2 me-md-3 fa-lg flex-shrink-0 mt-1 mt-md-0"></i>
                      {% elif file_ext == '.xls' or file_ext == 'xlsx' %}
                        <i class="fa-solid fa-file-excel text-success me-2 me-md-3 fa-lg flex-shrink-0 mt-1 mt-md-0"></i>
                      {% elif file_ext == '.jpg' or file_ext == '.jpeg' or file_ext == '.png' or file_ext == '.gif' %}
                        <i class="fa-solid fa-file-image text-warning me-2 me-md-3 fa-lg flex-shrink-0 mt-1 mt-md-0"></i>
                      {% else %}
                        <i class="fa-solid fa-file text-info me-2 me-md-3 fa-lg flex-shrink-0 mt-1 mt-md-0"></i>
                      {% endif %}
                    {% endwith %}
                    
                    <div class="min-w-0 flex-grow-1">
                      <div class="fw-bold text-responsive text-break">{{ fichier.fichier.name }}</div>
                      {% if fichier.description %}
                        <small class="text-muted d-block text-break">{{ fichier.description }}</small>
                      {% endif %}
                      <div class="text-muted">
                        <small class="text-xs-mobile">
                          <i class="fa-solid fa-calendar me-1"></i> {{ fichier.date_ajout|date:"d/m/Y H:i" }}
                        </small>
                      </div>
                    </div>
                  </div>
                  
                  <div class="d-flex gap-1 gap-md-2 flex-shrink-0">
                    <a href="{% url 'projets:afficher_fichier_suivi' fichier.id %}" 
                       target="_blank" class="btn btn-sm btn-info" title="Voir le fichier">
                      <i class="fa-solid fa-eye"></i>
                      <span class="d-none d-md-inline ms-1">Voir</span>
                    </a>
                    <a href="{% url 'projets:afficher_fichier_suivi' fichier.id %}?download=true" 
                       class="btn btn-sm btn-success" title="Télécharger">
                      <i class="fa-solid fa-download"></i>
                      <span class="d-none d-md-inline ms-1">Téléch.</span>
                    </a>
                    <form method="post" action="{% url 'projets:supprimer_fichier_suivi' fichier.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" 
                              onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce fichier?')" title="Supprimer">
                        <i class="fa-solid fa-trash"></i>
                        <span class="d-none d-md-inline ms-1">Suppr.</span>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-3">
          <i class="fa-solid fa-file-circle-question display-6 text-muted mb-2"></i>
          <p class="text-muted text-responsive">Aucun fichier joint à ce suivi.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  
  <script>
    // Configuration du sélecteur de date
    flatpickr("#date", {
      locale: "fr",
      dateFormat: "Y-m-d",
      allowInput: true
    });

    // Prévisualisation du texte (nombre de caractères)
    const commentaireTextarea = document.getElementById('commentaire');
    const caractereCount = document.getElementById('caractere-count');

    function updateCaractereCount() {
      const length = commentaireTextarea.value.length;
      caractereCount.textContent = `${length} caractères`;
      
      if (length > 1000) {
        caractereCount.classList.add('text-warning');
      } else {
        caractereCount.classList.remove('text-warning');
      }
    }

    commentaireTextarea.addEventListener('input', updateCaractereCount);
    updateCaractereCount(); // Initial count

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
      let isValid = true;
      const titre = document.getElementById('titre').value.trim();
      const commentaire = document.getElementById('commentaire').value.trim();
      
      if (!titre) {
        alert('Le titre est obligatoire');
        isValid = false;
      }
      
      if (!commentaire) {
        alert('Le commentaire est obligatoire');
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
      }
    });

    // Adaptation responsive pour les boutons de fichiers
    function adaptFileButtons() {
      const fileButtons = document.querySelectorAll('.fichier-item .btn');
      if (window.innerWidth < 768) {
        fileButtons.forEach(btn => {
          const span = btn.querySelector('span');
          if (span) {
            span.classList.add('d-none');
          }
        });
      } else {
        fileButtons.forEach(btn => {
          const span = btn.querySelector('span');
          if (span) {
            span.classList.remove('d-none');
          }
        });
      }
    }

    // Initial adaptation
    adaptFileButtons();
    
    // Re-adapt on resize
    window.addEventListener('resize', adaptFileButtons);
  </script>
</body>
</html>