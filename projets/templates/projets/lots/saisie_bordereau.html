<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bordereau - {{ lot.nom }}</title>
    {% load static %}
    {% load formatters %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css" />
    <link rel="stylesheet" href="{% static 'projets/css/handsontable-custom.css' %}">
    <script src="{% static 'projets/js/nombre-lettres.js' %}"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>
    <style>
        body { 
            background-color: #2E2E2E; 
            color: #AECBD6; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(59, 59, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); 
            border: none; 
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            border: none; 
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            border: none; 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            border: none; 
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); 
            border: none; 
            color: white; 
        }
        .form-control { 
            background-color: #3B3B3B; 
            border: 1px solid #4B5563; 
            color: #AECBD6; 
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        .form-control:focus { 
            border-color: #22d3ee; 
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2); 
            outline: none;
            background-color: #2E2E2E;
        }
        .form-control::placeholder {
            color: #6B7280;
        }
        .form-group {
            margin-bottom: 0.2rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #22d3ee;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
       
        /* Messages */
        .alert-auto-dismiss {
            animation: fadeOut 5s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .alert-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .alert-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .alert-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .alert-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; }

        .main-container {
            max-width: 1380px;
            margin: 0 auto;
            padding: 10px;
        }
        .header-section {
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            border: 1px solid #22d3ee;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .content-section {
            background: rgba(59, 59, 59, 0.8);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #4B5563;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }

        /* Total section */
        .total-section {
            background: linear-gradient(135deg, #1a3a1a 0%, #2d4d2d 100%);
            border: 1px solid #10b981;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* Toolbar styles */
        .toolbar {
            background: linear-gradient(135deg, #3B3B3B 0%, #2E2E2E 100%);
            border: 1px solid #4B5563;
            border-bottom: none;
            backdrop-filter: blur(10px);
            max-width: 1340px;
            margin: 0 auto;
            border-radius: 12px 12px 0 0;
            padding: 0.75rem 1rem;
        }
        .total-lot {
            background: linear-gradient(135deg, #1a2a3a 0%, #0f172a 100%);
            border: 1px solid #22d3ee;
            color: #22d3ee;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
        }    
    
        /* Styles pour la barre d'outils professionnelle */
        .btn-toolbar {
            @apply p-2 rounded-lg transition-all duration-200 ease-in-out flex items-center justify-center relative;
            min-width: 40px;
            height: 40px;
            border: 1px solid transparent;
        }

        .btn-toolbar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-toolbar:active {
            transform: translateY(0);
        }

        /* Couleurs des boutons */
        .btn-toolbar-primary { 
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); 
            color: white;
        }
        .btn-toolbar-info { 
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); 
            color: white;
        }
        .btn-toolbar-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white;
        }
        .btn-toolbar-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white;
        }
        .btn-toolbar-secondary { 
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); 
            color: white;
        }
        .btn-toolbar-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white;
        }

        .btn-toolbar-primary:hover { border-color: #22d3ee; }
        .btn-toolbar-info:hover { border-color: #0ea5e9; }
        .btn-toolbar-success:hover { border-color: #10b981; }
        .btn-toolbar-warning:hover { border-color: #f59e0b; }
        .btn-toolbar-secondary:hover { border-color: #9ca3af; }
        .btn-toolbar-danger:hover { border-color: #ef4444; }

        /* Animation des icônes */
        .btn-toolbar i {transition: transform 0.2s ease;}

        .btn-toolbar:hover i {transform: scale(1.1);}

        /* Style pour l'affichage de la somme des cellules sélectionnées */
        .selection-sum-display {
            position: fixed;
            bottom: 6px;
            right: 120px;
            background: #2E2E2E; 
            color: rgb(208, 208, 208);
            padding: 6px;
            border-radius: 10px;
            border: 2px solid #13ebee; 
            font-size: 16px;
            vertical-align: middle;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        @media print {
            .navigation-buttons, .btn, .btn-toolbar, .selection-sum-display {
                display: none;
            }
            .no-print {
                display: none;
            }
            .menu {
                display: hidden;
            }
        }

        /* ===== STYLES RESPONSIVES MOBILE ===== */
        @media (max-width: 768px) {
            .main-container {
                padding: 8px;
            }
            
            .header-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .header-section h1 {
                font-size: 1.5rem !important;
                text-align: center;
            }
            
            .header-section .flex {
                flex-direction: column;
                gap: 0.5rem !important;
                text-align: center;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .navigation-buttons .btn {
                width: 100%;
                justify-content: center;
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
            }
            
            .menu-fixed {
                position: relative;
                top: 0;
                margin-bottom: 0.75rem;
                padding: 0.5rem;
            }
            
            .menu-fixed .flex {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.25rem;
            }
            
            .btn-toolbar {
                min-width: 36px;
                height: 36px;
                padding: 0.5rem;
            }
            
            .btn-toolbar i {
                font-size: 0.875rem;
            }
            
            .content-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .content-section h3 {
                font-size: 1.1rem;
                text-align: center;
            }
            
            #hot {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
            }
            
            .handsontable-custom {
                min-width: 800px;
            }
            
            .total-section {
                padding: 0.75rem;
            }
            
            .total-section h5 {
                font-size: 0.9rem;
            }
            
            #total-lot {
                font-size: 1.1rem;
            }
            
            .selection-sum-display {
                position: fixed;
                bottom: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 4px 8px;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 5px;
            }
            
            .header-section {
                padding: 0.5rem;
                border-radius: 12px;
            }
            
            .header-section h1 {
                font-size: 1.25rem !important;
            }
            
            .header-section .text-xl,
            .header-section .text-2xl {
                font-size: 0.9rem !important;
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }
            
            .btn-toolbar {
                min-width: 32px;
                height: 32px;
            }
            
            .content-section {
                padding: 0.5rem;
                border-radius: 12px;
            }
            
            .total-section {
                padding: 0.5rem;
            }
            
            #total-lot {
                font-size: 1rem;
            }
            
            .handsontable-custom {
                min-width: 700px;
                font-size: 0.75rem !important;
            }
            
            .handsontable-custom thead th {
                font-size: 0.7rem !important;
                height: 35px !important;
            }
            
            .handsontable-custom tbody td {
                font-size: 0.7rem !important;
            }
        }

        /* Orientation paysage mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-container {
                padding: 5px;
            }
            
            .header-section {
                padding: 0.5rem;
            }
            
            .menu-fixed {
                padding: 0.25rem;
            }
            
            .content-section {
                padding: 0.5rem;
            }
            
            #hot {
                max-height: 60vh;
            }
        }

        /* Support tactile amélioré */
        @media (hover: none) and (pointer: coarse) {
            .btn-toolbar {
                min-width: 44px;
                height: 44px;
            }
            
            .btn {
                padding: 12px 16px;
            }
            
            .handsontable-custom tbody td {
                padding: 12px 8px !important;
            }
        }
    </style>
    <style>
        /* STYLES HIÉRARCHIE AMÉLIORÉS */
        .htCore td {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="selectionSumDisplay" class="selection-sum-display"></div>
    <div class="main-container">
        <!-- En-tête -->
        <header class="header-section">
            <div class="text-center">
                <h1 class="text-2xl md:text-4xl font-bold text-cyan-400 mb-3 md:mb-4 flex items-center justify-center gap-2 md:gap-3">
                    <i class="fas fa-file-invoice text-lg md:text-xl"></i>
                    Bordereau de Prix
                </h1>
                <div class="flex flex-col md:flex-row items-center justify-center gap-2 md:gap-4 text-sm md:text-base">
                    <span class="text-[#AECBD6]">Projet :</span>
                    <span class="font-bold text-cyan-300 border-b-2 border-cyan-400 pb-1 text-sm md:text-xl">
                        {{ lot.projet.nom }}
                    </span>
                    <span class="text-[#AECBD6]">Lot :</span>
                    <span class="font-bold text-green-300 border-b-2 border-green-400 pb-1 text-sm md:text-xl">
                        {{ lot.nom }}
                    </span>
                </div>
            </div>
        </header>

        <!-- Boutons de navigation -->
        <div class="navigation-buttons flex flex-col sm:flex-row gap-2 mb-3 md:mb-4">
            <button onclick="window.location.href='{% url 'projets:lots_projet' lot.projet.id %}'" 
                    class="btn btn-success">
                <i class="fas fa-cubes"></i> Retour aux lots
            </button>
            <button onclick="window.location.href='{% url 'projets:dashboard' lot.projet.id %}'" 
                    class="btn btn-info">
                <i class="fa-solid fa-diagram-project"></i> Retour au projet
            </button>
            <button onclick="window.location.href='{% url 'home' %}'" 
                    class="btn btn-warning">
                <i class="fa-solid fa-house"></i> Accueil
            </button>
        </div>

        <!-- Barre d'outils -->
        <div class="menu menu-fixed flex justify-between p-2 md:p-3 rounded-lg border border-gray-600 shadow-lg mb-3 md:mb-4">
            <div class="flex items-center no-print w-full justify-center md:justify-start">
                <div class="flex flex-wrap gap-1 md:gap-2 justify-center">
                    <!-- Bouton Sauvegarde -->
                    <button onclick="saveData()" 
                            id="save-btn"
                            class="btn-toolbar btn-toolbar-primary group"
                            title="Enregistrer les modifications">
                        <i class="fas fa-save"></i>
                    </button>
                    
                    <!-- Bouton Ajouter ligne enfant -->
                    <button onclick="insertChildLine()" 
                            class="btn-toolbar btn-toolbar-warning group"
                            title="Ajouter une ligne enfant">
                        <i class="fas fa-add"></i>
                    </button>
                    
                    <!-- Boutons Indentation -->
                    <button onclick="desindente()" 
                            class="btn-toolbar btn-toolbar-secondary group"
                            title="Désindenter (niveau -1)">
                        <i class="fas fa-outdent"></i>
                    </button>
                    
                    <button onclick="indente()" 
                            class="btn-toolbar btn-toolbar-info group"
                            title="Indenter (niveau +1)">
                        <i class="fas fa-indent"></i>
                    </button>
                    
                    <!-- Boutons Export -->
                    <button onclick="exportExcel()" 
                            class="btn-toolbar btn-toolbar-success group"
                            title="Exporter en Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    
                    <button onclick="exportPDF()" 
                            class="btn-toolbar btn-toolbar-danger group"
                            title="Exporter en PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Messages -->
        {% if messages %}
            <div class="mb-4 md:mb-6 space-y-2 md:space-y-3 no-print">
                {% for message in messages %}
                    <div class="alert-auto-dismiss p-3 md:p-4 rounded-xl alert-{{ message.tags }} flex justify-between items-center shadow-lg">
                        <div class="flex items-center gap-2 md:gap-3">
                            {% if message.tags == 'success' %}
                                <i class="fas fa-check-circle text-sm md:text-base"></i>
                            {% elif message.tags == 'error' %}
                                <i class="fas fa-exclamation-circle text-sm md:text-base"></i>
                            {% elif message.tags == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-sm md:text-base"></i>
                            {% else %}
                                <i class="fas fa-info-circle text-sm md:text-base"></i>
                            {% endif %}
                            <span class="font-medium text-sm md:text-base">{{ message }}</span>
                        </div>
                        <button type="button" onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 text-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Contenu principal -->
        <div class="content-section">
            <!-- Tableau Handsontable -->
            <div class="mb-3 md:mb-4">
                <h3 class="text-lg md:text-xl font-bold text-cyan-400 mb-3 md:mb-4 flex items-center justify-center gap-2">
                    <i class="fas fa-table"></i>
                    Détail des Prix Unitaires
                </h3>
                <div id="hot" class="handsontable-custom rounded-xl overflow-hidden"></div>
            </div>
        </div>
        
        <!-- Total général -->
        <div class="total-section">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                <!-- Titre à gauche -->
                <div class="flex items-center gap-2">
                    <i class="fas fa-calculator text-cyan-400 text-lg md:text-xl"></i>
                    <h5 class="text-cyan-300 text-base md:text-lg font-bold">
                        Total général du lot HT
                    </h5>
                </div>
                
                <!-- Total à droite -->
                <div class="flex items-center gap-2">
                    <span id="total-lot" class="text-white text-xl md:text-2xl font-bold">
                        0.00 MAD
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>// Class Line, LineManager
    class Line {
        constructor(id = null, numero = "N°", designation = "Désignation", unite = "U", quantite = 1, pu = 0, parent = null, _expanded = false) {
            this.id = id;
            this.children = [];
            this.numero = numero;
            this.designation = designation;
            this.unite = unite;
            this.quantite = quantite;
            this.prix_unitaire = pu;
            this.parent = parent;
            this._expanded = _expanded;
        }

        level() {
            let level = 0;
            let currentNode = this;
            while (currentNode.parent) {
                level += 1;
                currentNode = currentNode.parent;
            }
            return level;
        }
        
        forEachChild(callback) {
            self.children.forEach(callback);
        }

        getChildIndex(child) {
            return this.children.indexOf(child);
        }

        findChildById(id) {
            return this.children.find(child => child.id === id);
        }

        getPreviousSibling(child) {
            const index = this.getChildIndex(child);
            return index > 0 ? this.children[index - 1] : null;
        }

        getNextSibling(child) {
            const index = this.getChildIndex(child);
            return index < this.children.length - 1 ? this.children[index + 1] : null;
        }

        getFirstChild() {
            return this.children[0] || null;
        }

        getLastChild() {
            return this.children[this.children.length - 1] || null;
        }

        getChildrenCount() {
            return this.children.length;
        }

        hasChildren() {
            return this.children.length > 0;
        }

        addChild(child) {
            child.parent = this;
            this.children.push(child);
        }

        insertChildAt(child, index) {
            child.parent = this;
            this.children.splice(index, 0, child);
        }

        removeChild(child) {
            const index = this.getChildIndex(child);
            if (index !== -1) {
                this.children.splice(index, 1);
                child.parent = null;
                return true;
            }
            return false;
        }

        isExpanded() {
            return this._expanded;
        }

        toggleExpanded() {
            this._expanded = !this._expanded;
        }


        indent() {
            const parent = this.parent;
            if (!parent) return false;
            
            const currentIndex = parent.getChildIndex(this);
            if (currentIndex === 0) return false;
            
            const previousSibling = parent.children[currentIndex - 1];
            parent.removeChild(this);
            previousSibling.addChild(this);
            
            return true;
        }

        desindent() {
            const parent = this.parent;
            if (!parent) return false;
            // si cette ligne est n'est pas le dernier enfant de son parent, il ne peut pas se déindenter
            if (parent.getLastChild() !== this) return false;
            const grandParent = parent.parent;
            if (!grandParent) return false;
            
            const parentIndex = grandParent.getChildIndex(parent);
            parent.removeChild(this);
            grandParent.insertChildAt(this, parentIndex + 1);
            
            return true;
        }

        amount() {
            if (this.hasChildren()) {
                return this.children.reduce((total, child) => total + child.amount(), 0);
            }
            return this.quantite * this.prix_unitaire;
        }
    }

    class LineManager {
        constructor(lotNom = "Bordereau des prix unitaires", data = []) {
            this.lineMap = {};
            this.rootLine = new Line(null, "Root", lotNom);
            this.indexMap = {}; // Cache des index
            this.cachedFlatList = null; // Cache flatList
            this.cacheValid = false; // Flag de validité
            this.data = data;
            this.dataTable = data ? this.getTableData(data) : [];
        }
        insertChildAt(line, index) { // Insertion d'un enfant à une position index
            // Trouver le parent qui se trouve à la position index dans la liste flatList
            // verfier l'index est valide
            
            const flatList = this.getCachedFlatList();
            
            if (index < 0 || index >= flatList.length) return;
            try {
                const childLine = flatList[index];
                const parentLine = childLine.parent;
                if (!parentLine) return;

                const position= index - this.getIndexById(parentLine.id) - 1;
                parentLine.insertChildAt(line, position);
                this.invalidateCache(); 
            } catch (error) {
                console.error(error);
                return;
            }
            
        }
        
        removeChild(line) { // Suppression d'un enfant
            const parent = line.parent;
            if (!parent) return;
            parent.removeChild(line);
            this.invalidateCache();
        }

        indexOf(line) { // Retourne l'index de la ligne
            const flatList = this.getCachedFlatList();
            return flatList.indexOf(line);
        }

        buildTree(data) {
            this.lineMap = {};
            this.cacheValid = false; 
            // Créer tous les nodes
            data.forEach(row => {
                if (!row || row.id === null || row.id === undefined) return;
                
                let line = new Line(
                    row.id, 
                    row.numero || "",
                    row.designation || "New Line", 
                    row.unite || "", 
                    parseFloat(row.quantite) || 0, 
                    parseFloat(row.prix_unitaire) || 0,
                    null,
                    true // _expanded par défaut pour voir les données
                );
                this.lineMap[row.id] = line;
            });

            // Construire la hiérarchie
            data.forEach(row => {
                if (!row || !this.lineMap[row.id]) return;
                
                const line = this.lineMap[row.id];
                
                if (row.parent_id && this.lineMap[row.parent_id]) {
                    this.lineMap[row.parent_id].addChild(line);
                } else {
                    this.rootLine.addChild(line);
                }
            });
        }
        
        getUpdatedFlatList() {
            const flatList = this.getCachedFlatList();

            return flatList.map(line => ({
                id: line.id,
                parent_id: line.parent ? line.parent.id : null,
                numero: line.numero,
                niveau: line.level(),
                est_titre: line.hasChildren(),
                designation: line.designation,
                unite: line.unite,
                quantite: line.quantite,
                prix_unitaire: line.prix_unitaire,
                montant: line.amount(),
            }));
        }
        buildIndexMap() {
            this.indexMap = {};
            const flatList = this.getCachedFlatList();
            flatList.forEach((line, index) => {
                if (line && line.id) {
                    this.indexMap[line.id] = index;    //(line.id, index);
                }
            });
        }
        // Fonction pour convertir les données en format Handsontable
        getTableData(data) {
            this.buildTree(data);
            const flatList = this.getCachedFlatList();
            return flatList.map(line => ({
                _expanded: line.isExpanded(),
                id: line.id,
                parent_id: line.parent ? line.parent.id : null,
                numero: line.numero,
                niveau: line.level(),
                est_titre: line.hasChildren(),
                designation: line.designation,
                unite: line.unite,
                quantite: line.quantite,
                prix_unitaire: line.prix_unitaire,
                montant: line.amount(),
            }));
        }
        // GETTER optimisé
        getIndexById(id) {
            try {
                return this.indexMap[id];
            } catch (error) {
                return -1;
            }
            
        }
        
        getLineById(id) {
            if (!this.lineMap[id]) return null;
            return this.lineMap[id];
        }

        montantTotal() {
            return this.rootLine.amount();
        }

        getFlatList() {
            const result = [];
            
            const traverse = (line) => {
                result.push(line);

                if (line.children) {
                    line.children.forEach(child => traverse(child));
                }
            };
            
            this.rootLine.children.forEach(traverse);
            return result;
        }
        
        getCachedFlatList() {
            if (!this.cacheValid || !this.cachedFlatList) {
                this.cachedFlatList = this.getFlatList();
                this.cacheValid = true;
            }
            return this.cachedFlatList;
        }

        invalidateCache() {
            this.cacheValid = false;
            this.cachedFlatList = null;
        }
    
        removeLineByIndex(rowIndex) {
            const flatList = this.getCachedFlatList();
            const line = flatList[rowIndex];
            if (line) {
                line.parent.removeChild(line);
                this.invalidateCache();
            }
        }
        
        getLineByIndex(rowIndex) {
            const flatList = this.getCachedFlatList();
            return flatList[rowIndex];
        }
    
        indentLineByIndex(rowIndex) {
            const flatList = this.getCachedFlatList();
            const line = flatList[rowIndex];
            if (line) {
                line.indent();
                this.invalidateCache();
                return true;
            }
            return false;
        }
    
        desindentLineByIndex(rowIndex) {
            const flatList = this.getCachedFlatList();
            const line = flatList[rowIndex];
            if (line) {
                line.desindent();
                this.invalidateCache();
                return true;
            }
            return false;
        }
    }
</script>

<script>    // Variables globales    

    const data = JSON.parse('{{ lignes|escapejs }}');
    const lineManager = new LineManager("{{ lot.nom }}", data);

    // Variables globales
    let hot;
    let nextTempId = 1000;
    let hiddenRowsState = [];
    let cachedFlatList = null;
    let cacheValid = false;
    let updating = false;
    let dataChanged = false;
    // Pour garder en mémoire l'état d'expansion des parents
    const parentExpansionState = new Map();
    
    // Renderer personnalisé
    function hierarchyRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.TextRenderer.apply(this, arguments);
        line = lineManager.getLineByIndex(row);
        if (!line) return;
        
        const niveau = line.level(); 
        const isTitle = line.hasChildren(); 

        if (isTitle) {
            td.className = td.className + ' title-row';
        }
        
        if (prop === 'designation') {
            const indent = (niveau-1) * 15;
            td.style.paddingLeft = `${indent}px`;
            td.style.verticalAlign = 'middle';
            
            if (isTitle) {
                const isExpanded = line.isExpanded();
                const triangleClass = isExpanded ? 'triangle-expanded' : 'triangle-collapsed';
                td.innerHTML = `<span class="toggle-triangle ${triangleClass}" data-row="${row}"></span>${value}`;
            } else {
                td.textContent = value || '';
                td.style.paddingLeft = `${15 + indent}px`;
            }
        } else if (prop === 'unite') {
            td.className = td.className + ' htCenter';
        } 
    }

    function numericRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.NumericRenderer.apply(this, arguments);
        // const rowData = instance.getSourceDataAtRow(row);
        const line = lineManager.getLineByIndex(row);
        if (!line) return;
        
        if (line.hasChildren()) {
            td.textContent = '';
            td.className = td.className + ' title-row';
        } else {
            // const nv = value || 0;
            if (value === 0) {
                td.textContent = ''; 
            }    
        }
    }

    function montantRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.NumericRenderer.apply(this, arguments);
        if (prop !== 'montant') return;
        line = lineManager.getLineByIndex(row);
        if (!line) return;

        if (line.hasChildren()) {
            // Calculer le total des enfants
            // const id = line.id;
            // if (!id) return;
            const amount = line.amount(); 

            td.textContent = amount === 0 ? '' : formatNumber(amount);

            td.className ='htRight title-row';
        } else {
            const total = line.amount();
            
            instance.getSourceData()[row].montant = total;
            td.textContent = total === 0 ? '' : formatNumber(total);
            td.className = 'htRight montant-cell';
        }        
    }
        
    function formatNumber(value, decimals = 2) {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function updateTotal() {
        let total = lineManager.montantTotal();
        const totalFormatted = formatNumber(total);
        document.getElementById('total-lot').textContent = `${totalFormatted} MAD`;
    }

    function initializeNewRow(rowIndex) {
        // Vérifications très strictes
        if (typeof rowIndex !== 'number' || isNaN(rowIndex) || rowIndex < 0 || rowIndex >= hot.countRows()) {
            console.warn('RowIndex invalide:', rowIndex);
            return;
        }
            
            // Attendre que Handsontable soit complètement prêt
        setTimeout(() => {
            if (!hot || typeof hot.countRows !== 'function') {
                console.warn('Handsontable non disponible');
                return;
            }
            
            const totalRows = hot.countRows();
            if (rowIndex >= totalRows) {
                console.warn(`Ligne ${rowIndex} n'existe pas (total: ${totalRows} lignes)`);
                return;
            }
            
            try {
                // crée un Id de type int temporaire de type string : tempId
                if (updating) {
                    const newId = `temp${nextTempId++}`;
                    lineManager.insertChildAt(new Line(newId), rowIndex);
                    hot.updateSettings({ data: lineManager.getUpdatedFlatList() });
                    updating = false;
                } 
            } catch (error) {
                console.error(`Erreur critique ligne ${rowIndex}:`, error);
            }
        }, 10); // Délai très court mais suffisant
    }

    // Raccourcis clavier pour l'indentation
    function setupIndentationShortcuts() {
        document.addEventListener('keydown', function(e) {
            // Tab pour indenter (comme dans la plupart des éditeurs)
            if (e.key === 'Tab' && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                if (e.shiftKey) {
                    // Shift+Tab pour désindenter
                    desindente();
                } else {
                    // Tab pour indenter
                    indente();
                }
            }
            
            // Ctrl+→ pour indenter, Ctrl+← pour désindenter
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                indente();
            }
            
            if (e.ctrlKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                desindente();
            }
        });
    }

    // Initialiser les indentations
    document.addEventListener('DOMContentLoaded', function() {
        setupIndentationShortcuts();
    });
    
    function displaySelectionSum() {
        const result = getSumOfSelectedCells();
        const displayElement = document.getElementById('selectionSumDisplay');

        if (result && result.cellCount > 1) {

            const formattedSum = formatNumber(result.sum);
            displayElement.textContent = `Somme : ${formattedSum}`;
            displayElement.style.display = 'block';
        } else {
            displayElement.style.display = 'none';
        }
    }
    
    function getSumOfCells(selection) {
        const startRow = Math.min(selection[0], selection[2]);
        const endRow = Math.max(selection[0], selection[2]);
        const startCol = Math.min(selection[1], selection[3]);
        const endCol = Math.max(selection[1], selection[3]);

        let sum = 0;
        let cellCount = 0;
        for (let row = startRow; row <=endRow; row++) {
            for (let col =startCol; col <= endCol; col++) {
                const value = parseFloat(hot.getDataAtCell(row, col)) || 0;
                if (!isNaN(value) && value !== 0) {
                    sum += value;
                    cellCount++;
                }
            }
        }
        return {sum, cellCount};
    }
    
    function getSumOfSelectedCells() {
        const selectCells = hot.getSelected();

        let sum = 0;
        let cellCount = 0;
        if (!selectCells || selectCells.length === 0) return;
        selectCells.forEach(cells => {
            sum += getSumOfCells(cells).sum;
            cellCount += getSumOfCells(cells).cellCount;
        })

        return {sum, cellCount};
    }
    
    function getSafeSelection() {
        if (!hot) {
            return null;
        }
        
        const selected = hot.getSelected();
        
        if (!selected || !Array.isArray(selected) || selected.length === 0) {
            return null;
        }
        
        const [startRow, startCol, endRow, endCol] = selected[0];
        
        // Pour un clic simple, startRow = endRow et startCol = endCol
        const selectionInfo = {
            startRow: Math.min(startRow, endRow),
            startCol: Math.min(startCol, endCol),
            endRow: Math.max(startRow,  endRow),
            endCol: Math.max(startCol, endCol),
            isSingleCell: (startRow === endRow && startCol === endCol),
            // selectedCell: hot.getDataAtCell(startRow, startCol),
            // rowData: hot.getSourceDataAtRow(startRow),
        };
        
        return selectionInfo;
    }

    function indente() {// Fonction pour indenter (augmenter le niveau)
        const selection = getSafeSelection();
        
        if (!selection){
            alert("❌ Veuillez sélectionner une ligne à indenter");
            return;
        }
        
        const rowIndex = selection.startRow;
        let index = 0;
        for (let i = selection.startRow; i < selection.endRow+1; i++) {
            const result = lineManager.indentLineByIndex(i);
            dataChanged = true;
            if (!result) break;
        }
        hot.render();
    }

    function desindente() {// Fonction pour désindenter (diminuer le niveau)
        const selection = getSafeSelection();
        
        if (!selection) {
            alert("❌ Veuillez sélectionner une ligne à désindenter");
            return;
        }
        
        const rowIndex = selection.startRow;
        let index = 0;
        for (let i = selection.startRow; i < selection.endRow+1; i++) {
            const result = lineManager.desindentLineByIndex(i);
            dataChanged = true;
            if (!result) break;
        }
        hot.render();
    }
    
    function getHotConfig () {
        // Configuration Handsontable
        const hotConfig = {
            data: lineManager.getUpdatedFlatList(),
            columns: [
                {data: '_expanded', type: 'checkbox', title: 'e', width: 10,},
                {data: 'numero', type: 'text', title: 'N°', width: 50, renderer: hierarchyRenderer},
                {data: 'niveau', type: 'text', title: 'N', width: 20, renderer: hierarchyRenderer},
                {data: 'est_titre', type: 'checkbox', title: 'T', width: 20, hidden: true, renderer: hierarchyRenderer},
                {data: 'designation',   type: 'text', title: 'Désignation', width: 400, renderer: hierarchyRenderer},
                {data: 'unite', type: 'text', title: 'Unité', width: 100, renderer: hierarchyRenderer},
                {data: 'quantite', type: 'numeric', numericFormat: { pattern: '0,0.000' }, title: 'Quantité', width: 120,
                        renderer: numericRenderer},
                {data: 'prix_unitaire', type: 'numeric', numericFormat: { pattern: '0,0.00' }, title: 'PU (DH)', width: 120,
                        renderer: numericRenderer},
                {data: 'montant', type: 'numeric', readOnly: true, numericFormat: { pattern: '0,0.00' }, title: 'Montant (DH)', width: 140,
                        renderer: montantRenderer},
            ],
            // stretchH: 'all',
            rowHeaders: false,
            colHeaders: true,
            licenseKey: 'non-commercial-and-evaluation',
            contextMenu: ['row_above', 'row_below', 'remove_row'],
            hiddenColumns: {columns: [0, 2, 3], indicators: false},
            hiddenRows: true,
            minSpareRows: 2,
            height: 'auto',
            width: 'auto',
            rowHeights: 40,
            manualColumnResize: true,
            manualRowResize: false,
            autoRowSize: false,
            // EMPÊCHER la désélection au clic extérieur
            outsideClickDeselects: false,
        
            // Garder la sélection même en cas de clic extérieur
            persistentState: true,
                
            afterChange: function(changes, source) {
                if (changes) {
                    changes.forEach(function(change) {
                        const [row, prop, oldValue, newValue] = change;
                        const line = lineManager.getLineByIndex(row);

                        if (!line) return;
                        switch(prop) {
                            case 'numero': 
                                line.numero = newValue; 
                                dataChanged = true;
                                break;
                            case 'designation': 
                                line.designation = newValue; 
                                  dataChanged = true;
                                break;
                            case 'unite': 
                                line.unite = newValue; 
                                  dataChanged = true;
                                break;
                            case 'quantite': 
                                line.quantite = parseFloat(newValue) || 0; 
                                  dataChanged = true;
                                updateTotal();
                                hot.setDataAtRowProp(row, 'montant', line.amount(), 'recalc');
                                break;
                            case 'prix_unitaire': 
                                line.prix_unitaire = parseFloat(newValue) || 0; 
                                  dataChanged = true;
                                updateTotal();
                                hot.setDataAtRowProp(row, 'montant', line.amount(), 'recalc');
                                break;
                            case '_expanded': 
                                line._expanded = newValue;
                                // setTimeout(refreshTable, 50);
                                break;
                        }
                    });
                }
            },
            
            beforeChange: function(changes, source) {
                if (!changes) return true;
                
                changes.forEach(function(change) {
                    const [row, prop, oldValue, newValue] = change;
                    
                    if (prop === 'quantite' || prop === 'prix_unitaire') {
                        if (newValue !== null && parseFloat(newValue) < 0) {
                            alert("Les valeurs négatives ne sont pas autorisées");
                            return false;
                        }
                        if (newValue !== null && typeof newValue === 'string') {
                            const cleanedValue = newValue.replace(/\s/g, '').replace(',', '.');
                            if (newValue.trim() === '' || isNaN(cleanedValue)) {
                                change[3] = '';
                            } else {
                                change[3] = cleanedValue;
                            }
                        }
                    }
                });
                return true;
            },
            
            afterCreateRow: function(index, amount, source) {
                // Attendre plus longtemps pour les nouvelles créations
                setTimeout(() => {
                    if (hot && typeof hot.countRows === 'function') {
                        const currentRowCount = hot.countRows();
                        if (index >= 0 && index < currentRowCount-1) {
                            if (source !== 'auto') {
                                updating = true;
                                initializeNewRow(index);
                            }
                        }
                    }
                }, 100);
            },
            
            afterInsertRow: function(index, amount, source){
                initializeNewRow(index)
                },
            
            afterRemoveRow: function(index, amount, source){
                lineManager.removeLineByIndex(index);
                updateTotal();
            },
            
            afterSelection: displaySelectionSum,
            
            afterDeselect: function() {
                const displayElement = document.getElementById('selectionSumDisplay');
                if (displayElement) displayElement.style.display = 'none';
            },
        };
        return hotConfig;
    }
    
    function InitHondsonTable() {
        const container = document.getElementById('hot');
        if (container) {
            hot = new Handsontable(container, getHotConfig());
            updateTotal();
        }
        setTimeout(() => {
            setupTriangleToggle();
            initializeExpansionState();
        }, 100);
    }
    // Initialisation différée
    document.addEventListener('DOMContentLoaded', function() {
        // Attendre que le DOM soit complètement chargé
        InitHondsonTable();
        // Masquer automatiquement les messages après 3 secondes
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-auto-dismiss');
            alerts.forEach(alert => {
                alert.style.display = 'none';
            });
        }, 3000);
    });
 
    function insertChildLine() {
        // Fonction pour insérer une ligne enfant avant la ligne selectionnée et devient sa soeur precedente

        const selected = getSafeSelection();
        if (!selected) {
            alert("Veuillez sélectionner un titre pour ajouter une ligne enfant");
            return;
        }
        
        const rowIndex = selected.startRow;
        hot.alter('insert_row_above', rowIndex, 1);
        hot.selectCell(rowIndex, selected.startCol);
        dataChanged = true;
    }
    
    function afficherLoading(button, texte) {
        if (button) {
            button.disabled = true;
            button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${texte}`;
        }
    }
    
    function masquerLoading(button, texte) {
        if (button) {
            button.disabled = false;
            button.innerHTML = `<i class="fas fa-save"></i> ${texte}`;
        }
    }
    
    function setupTriangleToggle() {
        hot.addHook('afterOnCellMouseDown', function(event, coords, TD) {
            if (event.target.classList.contains('toggle-triangle')) {
                event.stopPropagation();

                const row = parseInt(event.target.getAttribute('data-row'));
                toggleChildrenVisibility(row);

                return false; // Empêcher la sélection normale
            }
        });
    }

    // Fonction récursive améliorée avec Set pour éviter les doublons
    function getDescendantIds(parentId) {
        const descendants = new Set();
        const stack = [parentId];
        
        while (stack.length > 0) {
            const currentId = stack.pop();
            const currentLine = lineManager.getLineById(currentId);

            if (currentLine && currentLine.hasChildren()) {
                currentLine.children.forEach(child => {
                    if (!descendants.has(child.id)) {
                        descendants.add(child.id);
                        stack.push(child.id);
                    }
                });
            }
        }
        return Array.from(descendants);
    }
    // Fonction pour obtenir les index à partir des IDs
    function getIndexesFromIds(ids) {
        const flatList = lineManager.getCachedFlatList();
        return ids.map(id => {
            return flatList.findIndex(line => line.id === id);
        }).filter(index => index !== -1);
    }
    
    function getIndexesFromIdsOptimized(ids) {
            return ids.map(id => lineManager.getIndexById(id)).filter(idx => idx !== -1);
        }
    
    function toggleParentRow(lineParent, isExpanded, parentRowIndex) {
        const descendantIds = getDescendantIds(lineParent.id);
        const descendantIndexes = getIndexesFromIdsOptimized(descendantIds);
        
        if (isExpanded) {
            // EXPANSION : Retirer les descendants de hiddenRowsState
            hiddenRowsState = hiddenRowsState.filter(index => 
                !descendantIndexes.includes(index)
            );
        } else {
            // COLLAPSE : Ajouter les descendants à hiddenRowsState
            const newHiddenIndexes = descendantIndexes.filter(index => 
                !hiddenRowsState.includes(index)
            );
            hiddenRowsState = [...hiddenRowsState, ...newHiddenIndexes];
        }
        // Mettre à jour l'état de la ligne
        lineParent._expanded = isExpanded;
        
        hot.setDataAtRowProp(parentRowIndex, '_expanded', isExpanded);

        // Mettre à jour Handsontable
        hot.updateSettings({
            hiddenRows: {
                rows: hiddenRowsState
            }
        });
        
        // Forcer le rendu pour mettre à jour les triangles
        hot.render();

        // Sauvegarder dans le state local aussi
        updateParentExpansionState(lineParent.id, isExpanded);
        }   
    
    function updateParentExpansionState(parentId, isExpanded) {
        parentExpansionState.set(parentId, isExpanded);
    }

    function isParentExpanded(parentId) {
        return parentExpansionState.get(parentId) || false;
    }

    // INITIALISATION AVEC ÉTAT EXPANDED
    function initializeExpansionState() {
        hiddenRowsState = [];
        lineManager.buildIndexMap();
        const flatList = lineManager.getCachedFlatList();

        flatList.forEach((line, index) => {
            if (line.hasChildren()) {
                // Initialiser l'état d'expansion
                const isExpanded = line._expanded; // !== undefined ? line._expanded : true;
                parentExpansionState.set(line.id, isExpanded);
                
                // Si le titre n'est pas expansé, masquer ses descendants
                if (!isExpanded) {
                    const descendantIds = getDescendantIds(line.id);
                    const descendantIndexes = getIndexesFromIdsOptimized(descendantIds);
                    hiddenRowsState.push(...descendantIndexes);
                }
            }
        });
        
        // Appliquer l'état initial
        hot.updateSettings({
            hiddenRows: {
                rows: hiddenRowsState
            }
        });
        
    }
    
    function onParentClick(lineParent, parentRowIndex) {
        const currentlyExpanded = isParentExpanded(lineParent.id);
        const newExpandedState = !currentlyExpanded;
        
        toggleParentRow(lineParent, newExpandedState, parentRowIndex);
    }
    
    function toggleChildrenVisibility(parentRow) {
        // const rowData = data[parentRow];
        const lineParent = lineManager.getLineByIndex(parentRow);

        if (lineParent && lineParent.hasChildren()) {
            onParentClick(lineParent, parentRow);
        }
    }

    function saveData() {
        const saveBtn = document.getElementById('save-btn');
        afficherLoading(saveBtn, "Enregistrement...");
        const sourceData = hot.getSourceData();
        
        // Mettre à jour les lignes
        let rowIndex = 0;// Index des lignes
        const finalData = sourceData
            .filter(row => row && row.designation && row.designation.trim() !== '')
            .map(row => {
                const line = lineManager.getLineByIndex(rowIndex++);
                const parent = line.parent;
                const niveau = line.level(); // Verifier si la ligne est à la racine
                const parentId = niveau > 1 ? parent.id : null; // niveau 1 est la racine
                return {
                    id: line.id,
                    numero: line.numero,
                    designation: line.designation,
                    unite: line.unite,
                    quantite: line.quantite,
                    prix_unitaire: line.prix_unitaire,
                    montant: line.amount(),
                    niveau: niveau,
                    est_titre: line.hasChildren(),
                    parent_id: parentId
                };
            });

        fetch("{% url 'projets:sauvegarder_lignes_bordereau' lot.id %}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(finalData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { 
                    throw new Error(text || response.statusText) 
                });
            }
            dataChanged = true;
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                alert("Données enregistrées avec succès !");
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert("Erreur d'enregistrement : " + error.message);
        });
        masquerLoading(saveBtn,"");
    }
    
    function exportExcel() {
        const exportData = hot.getData().filter(row => row && row[1] !== null && row[1] !== '');
        const wb = XLSX.utils.book_new();
        const wsData = [
            ['N°', 'Désignation', 'Unité', 'Quantité', 'PU (DH)', 'Montant (DH)'],
            ...exportData
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Bordereau");
        XLSX.writeFile(wb, "bordereau_{{ lot.nom|slugify }}.xlsx");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const exportData = hot.getData().filter(row => row && row[1] !== null && row[1] !== '');
        const headers = ['N°', 'Désignation', 'Unité', 'Quantité', 'PU (DH)', 'Montant (DH)'];
        const body = exportData.map(row => row.map(cell => {
            if(typeof cell === 'number') {
                return cell.toLocaleString('fr-FR', { minimumFractionDigits: 2 });
            }
            return cell || '';
        }));
        doc.text("Bordereau des prix unitaires - {{ lot.nom }}", 14, 15);
        doc.autoTable({
            head: [headers],
            body: body,
            startY: 20,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 123, 255] }
        });
        doc.save("bordereau_{{ lot.nom|slugify }}.pdf");
    }

</script>


    <style>
        /* Menu fixe responsive */
        .menu-fixed {
            position: sticky;
            top: 5px;
            z-index: 1000;
            background: rgba(59, 59, 59, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(34, 211, 238, 0.3);
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .menu-fixed {
                top: 0;
            }
        }

        /* ===== STYLES GÉNÉRAUX HANDSONTABLE ===== */      
        .handsontable-custom {
            background: transparent !important;
            border: none !important;
            font-family: 'Segoe UI', system-ui, sans-serif !important;
        }
        .handsontable-custom .montant-cell {
            font-weight: 600 !important;
            color: #34D399 !important;
            font-size: 13px !important;
        }   
        .handsontable-custom .title-row {
            background: #1F2937 !important;
            font-weight: 700 !important;
            color: #FBBF24 !important;
            font-size: 13px !important;
        }

        /* ===== EN-TÊTES DE COLONNES ===== */
        .handsontable-custom thead th {
            background: #374151 !important;
            color: #22d3ee !important;
            border:none !important;
            border-right: 1px solid rgba(144, 161, 185, 0.15) !important; 
            font-weight: 600 !important;
            font-size: 13px !important;
            text-transform: uppercase !important;
            height: 45px !important;
            text-align: center !important;
            vertical-align: middle !important;
        } 

        /* ===== CORPS DU TABLEAU ===== */
        .handsontable-custom tbody td {
            background: #3B3B3B !important;
            border: 1px solid rgba(144, 161, 185, 0.15) !important; 
            color: #E5E7EB !important;
            transition: all 0.2s ease !important;
            vertical-align: middle !important;
            font-size: 12px !important;
        }

        /* Alternance des lignes */
        .handsontable-custom tbody tr:nth-child(even) td {
            background: #363636;
        }
        
        .toggle-triangle {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
            vertical-align: middle; 
            line-height: 1;
        }

        .triangle-collapsed::before {
            display: inline-block;
            content: "▶ ";
            color: #22d3ee;
            font-size: 10px;
        }

        .triangle-expanded::before {
            display: inline-block;
            content: "▼ ";
            color: #22d3ee;
            font-size: 10px;
        } 
        
        /* Effet hover sur les triangles */
        .toggle-triangle:hover::before {
            color: #0ee91d !important;
            transform: scale(1.1);
        }

        /* Styles mobiles pour Handsontable */
        @media (max-width: 768px) {
            .handsontable-custom thead th {
                height: 35px !important;
                font-size: 11px !important;
            }
            
            .handsontable-custom tbody td {
                font-size: 11px !important;
                padding: 8px 4px !important;
            }
            
            .toggle-triangle {
                width: 10px;
                height: 10px;
            }
            
            .triangle-collapsed::before,
            .triangle-expanded::before {
                font-size: 8px;
            }
        }
    </style>
</body>
</html>