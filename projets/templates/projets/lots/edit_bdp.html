<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bordereau de prix - {{ lot.nom }}</title>
    {% load static %}
    {% load formatters %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css" />
    <link rel="stylesheet" href="{% static 'projets/css/handsontable-custom.css' %}">
    <script src="{% static 'projets/js/nombre-lettres.js' %}"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>
    <style>
        body { 
            background-color: #2E2E2E; 
            color: #AECBD6; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(59, 59, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); 
            border: none; 
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            border: none; 
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            border: none; 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            border: none; 
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); 
            border: none; 
            color: white; 
        }
        .form-control { 
            background-color: #3B3B3B; 
            border: 1px solid #4B5563; 
            color: #AECBD6; 
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        .form-control:focus { 
            border-color: #22d3ee; 
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2); 
            outline: none;
            background-color: #2E2E2E;
        }
        .form-control::placeholder {
            color: #6B7280;
        }
        .form-group {
            margin-bottom: 0.2rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #22d3ee;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
       
        /* Messages */
        .alert-auto-dismiss {
            animation: fadeOut 5s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .alert-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .alert-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .alert-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .alert-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; }

        .main-container {
            max-width: 1380px;
            margin: 0 auto;
            padding: 20px;
        }
        .header-section {
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            border: 1px solid #22d3ee;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.0rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .content-section {
            background: rgba(59, 59, 59, 0.8);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #4B5563;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }

        /* Total section */
        .total-section {
            background: linear-gradient(135deg, #1a3a1a 0%, #2d4d2d 100%);
            border: 1px solid #10b981;
            border-radius: 12px;
            padding: 1.0rem;
            margin: 1.0rem 0;
        }

        /* Toolbar styles */
        /* .toolbar-container {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0 2rem;
        } */
        .toolbar {
            background: linear-gradient(135deg, #3B3B3B 0%, #2E2E2E 100%);
            border: 1px solid #4B5563;
            border-bottom: none;
            backdrop-filter: blur(10px);
            max-width: 1340px;
            margin: 0 auto;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
        }
        .total-lot {
            background: linear-gradient(135deg, #1a2a3a 0%, #0f172a 100%);
            border: 1px solid #22d3ee;
            color: #22d3ee;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
        }    
    
/* Styles pour la barre d'outils professionnelle */
.btn-toolbar {
    @apply p-3 rounded-lg transition-all duration-200 ease-in-out flex items-center justify-center relative;
    min-width: 44px;
    height: 44px;
    border: 1px solid transparent;
}

.btn-toolbar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-toolbar:active {
    transform: translateY(0);
}

/* Couleurs des boutons */
.btn-toolbar-primary { 
    background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); 
    color: white;
}
.btn-toolbar-info { 
    background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); 
    color: white;
}
.btn-toolbar-success { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
    color: white;
}
.btn-toolbar-warning { 
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
    color: white;
}
.btn-toolbar-secondary { 
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); 
    color: white;
}
.btn-toolbar-danger { 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
    color: white;
}

.btn-toolbar-primary:hover { border-color: #22d3ee; }
.btn-toolbar-info:hover { border-color: #0ea5e9; }
.btn-toolbar-success:hover { border-color: #10b981; }
.btn-toolbar-warning:hover { border-color: #f59e0b; }
.btn-toolbar-secondary:hover { border-color: #9ca3af; }
.btn-toolbar-danger:hover { border-color: #ef4444; }

/* Animation des ic√¥nes */
.btn-toolbar i {transition: transform 0.2s ease;}

.btn-toolbar:hover i {transform: scale(1.1);}

/* Style pour l'affichage de la somme des cellules s√©lectionn√©es */
.selection-sum-display {
    position: fixed;
    bottom: 6px;
    right: 120px;
    background: #2E2E2E; 
    color: rgb(208, 208, 208);
    padding: 6px;
    border-radius: 10px;
    border: 2px solid #13ebee; 
    font-size: 16px;
    vertical-align: middle;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
}
@media print {
     .navigation-buttons, .btn, .btn-toolbar, .selection-sum-display {
        display: none;
    }
    .no-print {
        display: none;
    }
    .menu {
        display: hidden;
    }
}
/* Responsive */
@media (max-width: 768px) {
    .btn-toolbar {
        padding: 2.5px;
        min-width: 40px;
        height: 40px;
    }
    
    .btn-toolbar i {
        font-size: 14px;
    }
}
</style>
<style>
/* STYLES HI√âRARCHIE AM√âLIOR√âS */
.htCore td {
    transition: all 0.3s ease;
}


</style>
</head>
<body>
    <div id="selectionSumDisplay" class="selection-sum-display"></div>
    <div class="main-container">
        <!-- En-t√™te -->
        <header class="header-section">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-cyan-400 mb-4 flex items-center justify-center gap-3">
                    <i class="fas fa-file-invoice"></i>
                    Bordereau de Prix
                </h1>
                <div class="flex items-center justify-center gap-4">
                    <span class="text-xl text-[#AECBD6]">Projet :</span>
                    <span class="text-2xl font-bold text-cyan-300 border-b-2 border-cyan-400 pb-1">
                        {{ lot.projet.nom }}
                    </span>
                    <span class="text-xl text-[#AECBD6]">Lot :</span>
                    <span class="text-2xl font-bold text-green-300 border-b-2 border-green-400 pb-1">
                        {{ lot.nom }}
                    </span>
                </div>
            </div>
        </header>
        <div class="navigation-buttons flex gap-3 mb-4">
            <button onclick="window.location.href='{% url 'projets:lots_projet' lot.projet.id %}'" 
                    class="btn btn-success">
                <i class="fas fa-cubes"></i> Retour aux lots
            </button>
            <button onclick="window.location.href='{% url 'projets:dashboard' lot.projet.id %}'" 
                    class="btn btn-info">
                <i class="fa-solid fa-diagram-project"></i> Retour au projet
            </button>
            <button onclick="window.location.href='{% url 'home' %}'" 
                    class="btn btn-warning">
                <i class="fa-solid fa-house"></i> Accueil
            </button>
        </div>
         <!-- Barre d'outils -->
        <div class="menu flex justify-between p-2 rounded-lg border border-gray-600 shadow-lg mb-4">
            <div class="flex items-center no-print">
                <!-- Boutons navigation -->
                <div class=" flex items-center gap-1 mr-2 pr-3 border-r border-gray-600">
                    <div class="flex flex-wrap gap-1">
                        <button onclick="saveData()" 
                                id="save-button"
                                class="btn-toolbar btn-toolbar-primary group"
                                title="Enregistrer les modifications"
                                tooltip="Enregistrer les modifications">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Groupe Hi√©rarchie -->
                <div class="flex items-center gap-1 mr-2 pr-3 border-r border-gray-600">
                    <button onclick="addTitleLine()" 
                            class="btn-toolbar btn-toolbar-info group"
                            title="Ajouter un titre/section"
                            tooltip ="Ajouter un titre/section">
                        <i class="fas fa-heading"></i>
                    </button>
                    
                    <button onclick="addChildLine()" 
                            class="btn-toolbar btn-toolbar-warning group"
                            title="Ajouter une ligne enfant"
                            tooltip="Ajouter une ligne enfant">
                        <i class="fas fa-add"></i>
                    </button>
                </div>
                
                <!-- Groupe Indentation -->
                <div class="indentation-controls flex items-center gap-1 mr-2 pr-3 border-r border-gray-600">                    
                    <button onclick="desindentCurrent()" 
                            class="btn-toolbar btn-toolbar-secondary group"
                            title="D√©sindenter (Ctrl+[)"
                            tooltip="D√©sindenter (Ctrl+[)">
                        <i class="fas fa-outdent"></i>
                    </button>

                    <button onclick="indentCurrent()" 
                            class="btn-toolbar btn-toolbar-info group"
                            title="Indenter (niveau +1) "
                            tooltip="Indenter (niveau +1)">
                        <i class="fas fa-indent"></i>
                    </button>
                    <span style="margin-left: 20px; color: #666;">
                        Raccourcis: Tab = Indenter | Shift+Tab = D√©sindenter
                    </span>
                </div>
                <!-- Groupe Actions -->
                <div class="flex items-center gap-1">
                    <button onclick="exportExcel()" 
                            class="btn-toolbar btn-toolbar-success group"
                            title="Exporter en Excel"
                            tooltip="Exporter en Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    
                    <button onclick="exportPDF()" 
                            class="btn-toolbar btn-toolbar-danger group"
                            title="Exporter en PDF"
                            tooltip="Exporter en PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
            </div>
            
        </div>
        
        <!-- Messages -->
        {% if messages %}
            <div class="mb-6 space-y-3 no-print">
                {% for message in messages %}
                    <div class="alert-auto-dismiss p-4 rounded-xl alert-{{ message.tags }} flex justify-between items-center shadow-lg">
                        <div class="flex items-center gap-3">
                            {% if message.tags == 'success' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif message.tags == 'error' %}
                                <i class="fas fa-exclamation-circle"></i>
                            {% elif message.tags == 'warning' %}
                                <i class="fas fa-exclamation-triangle"></i>
                            {% else %}
                                <i class="fas fa-info-circle"></i>
                            {% endif %}
                            <span class="font-medium">{{ message }}</span>
                        </div>
                        <button type="button" onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 text-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Contenu principal -->
        <div class="content-section">
            <!-- Tableau Handsontable -->
            <div class="mb-4">
                <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-table"></i>
                    D√©tail des Prix Unitaires
                </h3>

                <div id="hot" class="handsontable-custom rounded-xl overflow-hidden"></div>
            </div>
        </div>
        <!-- Total g√©n√©ral -->
        <div class="total-section">
            <div class="flex justify-between items-center">
                <!-- Titre √† gauche -->
                <div class="flex items-center gap-3">
                    <i class="fas fa-calculator text-cyan-400 text-xl"></i>
                    <h5 class="text-cyan-300 text-lg font-bold">
                        Total g√©n√©ral du lot HT
                    </h5>
                </div>
                
                <!-- Total √† droite -->
                <div class="flex items-center gap-2">
                    <span id="total-lot" class="text-white text-2xl font-bold">
                        0.00 MAD
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>



<script>
    class Node {
        constructor(id = null, numero = "", designation = "New Line", unite = "", quantite = 0, pu = 0, parent = null, _expanded = false) {
            this.id = id;
            this.children = [];
            this.numero = numero;
            this.designation = designation;
            this.unite = unite;
            this.quantite = quantite;
            this.pu = pu;
            this.parent = parent;
            this._expanded = _expanded;
        }

        forEachChild(callback) {
            this.children.forEach(callback);
        }

        getChildIndex(childNode) {
            return this.children.indexOf(childNode);
        }

        findChildById(id) {
            return this.children.find(child => child.id === id);
        }

        getPreviousSibling(childNode) {
            const index = this.getChildIndex(childNode);
            return index > 0 ? this.children[index - 1] : null;
        }

        getNextSibling(childNode) {
            const index = this.getChildIndex(childNode);
            return index < this.children.length - 1 ? this.children[index + 1] : null;
        }

        getFirstChild() {
            return this.children[0] || null;
        }

        getLastChild() {
            return this.children[this.children.length - 1] || null;
        }

        getChildrenCount() {
            return this.children.length;
        }

        hasChildren() {
            return this.children.length > 0;
        }

        addChild(childNode) {
            childNode.parent = this;
            this.children.push(childNode);
        }

        insertChildAt(childNode, index) {
            childNode.parent = this;
            this.children.splice(index, 0, childNode);
        }

        removeChild(childNode) {
            const index = this.getChildIndex(childNode);
            if (index !== -1) {
                this.children.splice(index, 1);
                childNode.parent = null;
                return true;
            }
            return false;
        }

        isExpanded() {
            return this._expanded;
        }

        toggleExpanded() {
            this._expanded = !this._expanded;
        }

        level() {
            let level = 0;
            let currentNode = this;
            while (currentNode.parent) {
                level += 1;
                currentNode = currentNode.parent;
            }
            return level;
        }

        indent() {
            const parent = this.parent;
            if (!parent) return false;
            
            const currentIndex = parent.getChildIndex(this);
            if (currentIndex === 0) return false;
            
            const previousSibling = parent.children[currentIndex - 1];
            parent.removeChild(this);
            previousSibling.addChild(this);
            
            return true;
        }

        desindent() {
            const parent = this.parent;
            if (!parent) return false;
            
            const grandParent = parent.parent;
            if (!grandParent) return false;
            
            const parentIndex = grandParent.getChildIndex(parent);
            parent.removeChild(this);
            grandParent.insertChildAt(this, parentIndex + 1);
            
            return true;
        }

        amount() {
            if (this.hasChildren()) {
                return this.children.reduce((total, child) => total + child.amount(), 0);
            }
            return this.quantite * this.pu;
        }
    }

    class NodeManager {
        constructor(lotNom = "Bordereau des prix unitaires") {
            this.nodeMap = {};
            this.rootNode = new Node(null, "Root", lotNom);
        }

        buildTree(data) {
            this.nodeMap = {};

            // Cr√©er tous les nodes
            data.forEach(row => {
                if (!row || row.id === null || row.id === undefined) return;
                
                let node = new Node(
                    row.id, 
                    row.numero || "",
                    row.designation || "New Line", 
                    row.unite || "", 
                    parseFloat(row.quantite) || 0, 
                    parseFloat(row.prix_unitaire) || 0,
                    null,
                    true // _expanded par d√©faut pour voir les donn√©es
                );
                this.nodeMap[row.id] = node;
            });

            // Construire la hi√©rarchie
            data.forEach(row => {
                if (!row || !this.nodeMap[row.id]) return;
                
                const node = this.nodeMap[row.id];
                
                if (row.parent_id && this.nodeMap[row.parent_id]) {
                    this.nodeMap[row.parent_id].addChild(node);
                } else {
                    this.rootNode.addChild(node);
                }
            });
        }

        findNodeById(id) {
            return this.nodeMap[id];
        }

        montantTotal() {
            return this.rootNode.amount();
        }

        getFlatList() {
            const result = [];
            
            const traverse = (node) => {
                result.push(node);
                // Toujours afficher les enfants pour le test
                if (node.children) {
                    node.children.forEach(child => traverse(child));
                }
            };
            
            this.rootNode.children.forEach(traverse);
            return result;
        }

        getNodeByRowIndex(rowIndex) {
            const flatList = this.getFlatList();
            return flatList[rowIndex];
        }
    }

    // Variables globales
    let hot = null;
    let isRefreshing = false;
    const nodeManager = new NodeManager("{{ lot.nom }}");

    // DEBUG: V√©rifier les donn√©es Django
    const bpData = JSON.parse('{{ lignes|escapejs }}');
    // nodeManager.buildTree(bpData);
    // Fonctions de gestion des donn√©es - VERSION CORRIG√âE
    function getTableData() {
        
        const flatList = nodeManager.getFlatList();
        // FORMAT TABLEAU DE TABLEAUX (plus simple)
        return flatList.map(node => [
            Boolean(node._expanded),           // col 0
            String(node.numero || ''),         // col 1  
            String(node.designation || ''),    // col 2
            String(node.unite || ''),          // col 3
            Number(node.quantite) || 0,       // col 4
            Number(node.pu) || 0,             // col 5
            Number(node.amount()) || 0 // col 6
        ]);
    }

    function refreshTable() {
        if (isRefreshing) {
            return;
        }
        
        isRefreshing = true;
        
        try {
            const newData = getTableData();
            
            if (newData && newData.length > 0) {
                if (hot) {
                    return;
                }
                console.log(hot ? ' hot existe' : 'hot is null');
                hot.loadData(newData);
            } else {
                // Forcer le chargement avec des donn√©es de test
                hot.loadData([{
                    _expanded: false,
                    numero: "TEST",
                    designation: "Donn√©es de test - V√©rifiez la console",
                    unite: "unit√©",
                    quantite: 1,
                    prix_unitaire: 1,
                    montant: 1,
                    _level: 0,
                    _isTitre: false
                }]);
            }
            
        } catch (error) {
            console.error('üí• Erreur lors du refresh:', error);
        } finally {
            isRefreshing = false;
        }
    }

    function updateTotal() {
        const total = nodeManager.montantTotal();
        const totalElement = document.getElementById('total-lot');
        if (totalElement) {
            totalElement.textContent = total.toFixed(2);
        }
    }

    // Fonctions de rendu simplifi√©es
    function hierarchyRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.TextRenderer.apply(this, arguments);
        
        const rowData = instance.getSourceDataAtRow(row);
        if (!rowData) return td;

        if (rowData._isTitre) {
            td.style.fontWeight = 'bold';
            td.style.backgroundColor = '#f0f0f0';
        }

        if ((col === 1 || col === 2) && rowData._level) {
            td.style.paddingLeft = (rowData._level * 20) + 'px';
        }

        return td;
    }

    function numericRenderer(instance, td, row, col, prop, value, cellProperties) {
        const rowData = instance.getSourceDataAtRow(row);
        
        if (rowData && rowData._isTitre) {
            td.textContent = rowData.montant !== null ? rowData.montant.toFixed(2) : '0.00';
            td.style.fontWeight = 'bold';
            td.style.backgroundColor = '#f0f0f0';
        } else {
            Handsontable.renderers.NumericRenderer.apply(this, arguments);
        }
        
        return td;
    }
    function montantRenderer(instance, td, row, col, prop, value, cellProperties) {
        try {
            const rowData = instance.getSourceDataAtRow(row);
            const node = rowData ? rowData._node : null;
            
            if (!node) {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                return td;
            }
            
            if (node.hasChildren()) {
                // TITRE : Montant total du sous-arbre
                const montant = node.amount();
                td.textContent = !isNaN(montant) ? montant.toFixed(2) : '0.00';
                td.className = 'title-row montant-titre';
                td.style.fontWeight = 'bold';
                td.style.textAlign = 'right';
                td.style.backgroundColor = '#f8f9fa';
            } else {
                // LIGNE NORMALE : Montant de la ligne
                const montant = node.amount();
                td.textContent = !isNaN(montant) ? montant.toFixed(2) : '0.00';
                td.className = '';
                td.style.fontWeight = 'normal';
                td.style.textAlign = 'right';
                td.style.backgroundColor = '';
            }
        } catch (error) {
            // Fallback en cas d'erreur
            Handsontable.renderers.NumericRenderer.apply(this, arguments);
        }
        
        return td;
    }
    function checkboxRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.CheckboxRenderer.apply(this, arguments);
        return td;
    }

    function displaySelectionSum() {
        const result = showSumSelectedCells(hot);
        const displayElement = document.getElementById('selectionSumDisplay');

        if (result && result.cellCount > 1) {

            const formattedSum = formatNumber(result.sum, 2);
            displayElement.textContent = `Somme : ${formattedSum}`;
            displayElement.style.display = 'block';
        } else {
            displayElement.style.display = 'none';
        }
    }
    
    nodeManager.buildTree(bpData);
    const container = document.getElementById('hot');
    const data = getTableData();
    console.log('data', data);
    // Configuration Handsontable simplifi√©e
    const hotConfig = {
        data: data, 
        columns: [
            { // checkbox
                data: '_expanded', 
                type: 'checkbox', 
                title: 'e', 
                width: 10,
                renderer: hierarchyRenderer
            },
            { // N¬∞
                data: 'numero', 
                type: 'text', 
                title: 'N¬∞', 
                width: 50,
                renderer: hierarchyRenderer
            },
            { // D√©signation
                data: 'designation',   
                type: 'text', 
                title: 'D√©signation', 
                width: 400,
                renderer: hierarchyRenderer
            },
            { // Unit√©
                data: 'unite', 
                type: 'text', 
                title: 'Unit√©', 
                width: 100,
                renderer: hierarchyRenderer
            },
            { // Quantit√©
                data: 'quantite', 
                type: 'numeric', 
                numericFormat: { pattern: '0,0.000' }, 
                title: 'Quantit√©', 
                width: 120,
                renderer: numericRenderer
            },
            { // PU
                data: 'prix_unitaire', 
                type: 'numeric', 
                numericFormat: { pattern: '0,0.00' }, 
                title: 'PU (DH)', 
                width: 120,
                renderer: numericRenderer
            },
            { // Montant
                data: 'montant', 
                type: 'numeric', 
                readOnly: true, 
                numericFormat: { pattern: '0,0.00' }, 
                title: 'Montant (DH)', 
                width: 140,
                renderer: montantRenderer
            },
        ],
  
        rowHeaders: false,
        colHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        minSpareRows: 1,
        height: 'auto',
        width: 'auto',
        rowHeights: 40,
        hiddenRows: true,
        manualColumnResize: true,
        manualRowResize: false,
        autoRowSize: false,
        // EMP√äCHER la d√©s√©lection au clic ext√©rieur
        outsideClickDeselects: false,
    
        // Garder la s√©lection m√™me en cas de clic ext√©rieur
        persistentState: true,
        // afterChange : function(changes, source) {
        //     if (!changes || source === 'loadData') return;

        //     changes.forEach(function(change) {
        //         const [row, prop, oldValue, newValue] = change;
        //         const node = nodeManager.getNodeByRowIndex(row);
                
        //         if (!node) return;

        //         switch(prop) {
        //             case 'numero': 
        //                 node.numero = newValue; 
        //                 break;
        //             case 'designation': 
        //                 node.designation = newValue; 
        //                 break;
        //             case 'unite': 
        //                 node.unite = newValue; 
        //                 break;
        //             case 'quantite': 
        //                 node.quantite = parseFloat(newValue) || 0; 
        //                 break;
        //             case 'prix_unitaire': 
        //                 node.pu = parseFloat(newValue) || 0; 
        //                 break;
        //             case '_expanded': 
        //                 node._expanded = newValue;
        //                 setTimeout(refreshTable, 50);
        //                 break;
        //         }

        //         if (prop === 'quantite' || prop === 'prix_unitaire') {
        //             updateTotal();
        //         }
        //     });
        // },
        
        // beforeChange: function(changes, source) {
        //     if (!changes) return true;
            
        //     changes.forEach(function(change) {
        //         const [row, prop, oldValue, newValue] = change;
                
        //         if (prop === 'quantite' || prop === 'prix_unitaire') {
        //             if (newValue !== null && parseFloat(newValue) < 0) {
        //                 alert("Les valeurs n√©gatives ne sont pas autoris√©es");
        //                 return false;
        //             }
        //             if (newValue !== null && typeof newValue === 'string') {
        //                 const cleanedValue = newValue.replace(/\s/g, '').replace(',', '.');
        //                 if (newValue.trim() === '' || isNaN(cleanedValue)) {
        //                     change[3] = '';
        //                 } else {
        //                     change[3] = cleanedValue;
        //                 }
        //             }
        //         }
        //     });
        //     return true;
        // },
        
        // afterSelection: displaySelectionSum,
        // // Afficher la somme des quantit√©s et des montants au-dessus du tableau        
        // afterDeselect: function() {
        //     const displayElement = document.getElementById('selectionSumDisplay');
        //     if (displayElement) displayElement.style.display = 'none';
        // },
    };

    hot = new Handsontable(container, hotConfig);
    console.log(hotConfig.data)
    console.log(hot.getSourceData())

    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case ']': // Ctrl + ] pour indenter
                        e.preventDefault();
                        indentCurrent();
                        break;
                    case '[': // Ctrl + [ pour d√©sindenter
                        e.preventDefault();
                        desindentCurrent();
                        break;
                    case 'Tab': // Tab pour indenter, Shift+Tab pour d√©sindenter
                        if (hot.isListening()) {
                            e.preventDefault();
                            if (e.shiftKey) {
                                desindentCurrent();
                            } else {
                                indentCurrent();
                            }
                        }
                        break;
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
       
        // console.log('- Donn√©es brutes:', hot.getData());
        // console.log('- Source data:', hot.getSourceData());
        // console.log('- Cellule 0,1:', hot.getDataAtCell(0, 1));
        // console.log('- Cellule 0,1 visible?', document.querySelector('.htCore td'));

        // Force un rendu
        // setupKeyboardShortcuts();
    });
</script>

<script>
    function updateIndentationButtons() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const node = nodeManager.getNodeByRowIndex(startRow);
        
        const indentBtn = document.querySelector('button[onclick="indentCurrent()"]');
        const desindentBtn = document.querySelector('button[onclick="desindentCurrent()"]');
        
        if (node) {
            // V√©rifier si l'indentation est possible
            const canIndent = node.parent && node.parent.getChildIndex(node) > 0;
            const canDesindent = node.parent && node.parent.parent;
            
            indentBtn.disabled = !canIndent;
            desindentBtn.disabled = !canDesindent;
        }
    }
    
    function setupTriangleToggle() {
        // Utiliser le syst√®me d'√©v√©nements de Handsontable
        hot.addHook('afterOnCellMouseDown', function(event, coords, TD) {
            if (event.target.classList.contains('toggle-triangle')) {
                event.stopPropagation();

                const row = parseInt(event.target.getAttribute('data-row'));
                toggleChildrenVisibility(row);
                return false; // Emp√™cher la s√©lection normale
            }
        });
    }

    function toggleChildrenVisibility(parentRow) {
        const parentData = hot.getSourceDataAtRow(parentRow);
        if (!parentData || !parentData.est_titre) return;
        
        const node = findNodeById(parentData.id);
        if ( node.children.length === 0) return;
        
        
        // G√©rer les valeurs undefined/null
        const currentExpanded = parentData._expanded;
        const isExpanded = currentExpanded === undefined ? false : !currentExpanded;
        hot.setDataAtRowProp(parentRow, '_expanded', isExpanded);
        // parentData._expanded = isExpanded;
        // IDs des enfants directs
        const childIds = node.children.map(child => child.id);
            
        // Mettre √† jour l'√©tat global
        if (isExpanded) {
            // Retirer les enfants de cet parent des lignes cach√©es
            hiddenRowsState = hiddenRowsState.filter(rowIndex => {
                const rowData = bpData[rowIndex];
                return !childIds.includes(rowData.id);
            });
        } else {
            // Ajouter les enfants de cet parent aux lignes cach√©es
            bpData.forEach((rowData, index) => {
                if (childIds.includes(rowData.id) && !hiddenRowsState.includes(index)) {
                    hiddenRowsState.push(index);
                }
            });
        }
        
        hot.updateSettings({
            hiddenRows: {
                rows: isExpanded ? [] : hiddenRowsState
            }
        });
    }

    function formatNumber(value, decimals = 2) {
        return value.toLocaleString('fr-FR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function showSumSelectedCells(hotInstance) {
        const selection = hotInstance.getSelected();
        if (!selection || selection.length === 0) return;
        
        let [startRow, startCol, endRow, endCol] = selection[0];
        if (startRow === endRow && startCol === endCol) return; // Une seule cellule s√©lectionn√©e

        // Ajuster si n√©cessaire
        if (startRow > endRow) [startRow, endRow] = [endRow, startRow];
        if (startCol > endCol) [startCol, endCol] = [endCol, startCol];

        let sum = 0;
        let cellCount = 0;
        
        for (let row = startRow; row <= endRow; row++) {
            for (let col = startCol; col <= endCol; col++) {
                if (col < 3) continue;
                
                let value = 0;
                
                value = parseFloat(hotInstance.getDataAtCell(row, col)) || 0;
                if (!isNaN(value) && value !== 0) {
                    sum += value;
                    cellCount++;
                }
            }
        }
        return { sum, cellCount };
    }

    // Indenter la ligne s√©lectionn√©e (devenir enfant du pr√©c√©dent)
    function indentSelected() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const node = nodeManager.getNodeByRowIndex(startRow);
        
        if (node && node.indent()) {
            refreshTreeDisplay();
            updateTotal();
        } else {
            alert("Impossible d'indenter cette ligne");
        }
    }

    // D√©sindenter la ligne s√©lectionn√©e (devenir fr√®re du parent)
    function desindentSelected() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const node = nodeManager.getNodeByRowIndex(startRow);
        
        if (node && node.desindent()) {
            refreshTreeDisplay();
            updateTotal();
        } else {
            alert("Impossible de d√©sindenter cette ligne");
        }
    }

    // Indenter plusieurs lignes s√©lectionn√©es
    function indentMultiple() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const endRow = selected[2];
        let success = true;
        
        // Indenter de bas en haut pour √©viter les probl√®mes d'index
        for (let row = endRow; row >= startRow; row--) {
            const node = nodeManager.getNodeByRowIndex(row);
            if (node && !node.indent()) {
                success = false;
                break;
            }
        }
        
        if (success) {
            refreshTreeDisplay();
            updateTotal();
        } else {
            alert("Impossible d'indenter certaines lignes");
        }
    }

    // D√©sindenter plusieurs lignes s√©lectionn√©es
    function desindentMultiple() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const endRow = selected[2];
        let success = true;
        
        // D√©sindenter de haut en bas
        for (let row = startRow; row <= endRow; row++) {
            const node = nodeManager.getNodeByRowIndex(row);
            if (node && !node.desindent()) {
                success = false;
                break;
            }
        }
        
        if (success) {
            refreshTreeDisplay();
            updateTotal();
        } else {
            alert("Impossible de d√©sindenter certaines lignes");
        }
    }

    // Fonction intelligente qui choisit entre simple et multiple
    function indentCurrent() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const endRow = selected[2];
        
        if (startRow === endRow) {
            indentSelected();
        } else {
            indentMultiple();
        }
    }

    // Fonction intelligente pour d√©sindenter
    function desindentCurrent() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const startRow = selected[0];
        const endRow = selected[2];
        
        if (startRow === endRow) {
            desindentSelected();
        } else {
            desindentMultiple();
        }
    }
    // Fonction pour afficher le chargement
    function afficherLoading(button, texte) {
        if (button) {
            button.disabled = true;
            button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${texte}`;
        }
    }
    function saveData() {
        const saveBtn = document.getElementById('save-btn');
        afficherLoading(saveBtn, "Enregistrement...");
        const sourceData = hot.getSourceData();
        
        const finalData = sourceData
            .filter(row => row && row.designation && row.designation.trim() !== '')
            .map(row => ({
                id: row.id,
                numero: row.numero,
                designation: row.designation,
                unite: row.unite,
                quantite: row.quantite || 0,
                prix_unitaire: row.prix_unitaire || 0,
                niveau: row.niveau || 0,
                est_titre: row.est_titre || false,
                parent_id: row.parent_id || null
            }));
        
        fetch("{% url 'projets:sauvegarder_lignes_bordereau' lot.id %}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(finalData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { 
                    throw new Error(text || response.statusText) 
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                alert("Donn√©es enregistr√©es avec succ√®s !");
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert("Erreur d'enregistrement : " + error.message);
        });
    }

    function exportExcel() {
        const exportData = hot.getData().filter(row => row && row[1] !== null && row[1] !== '');
        const wb = XLSX.utils.book_new();
        const wsData = [
            ['N¬∞', 'D√©signation', 'Unit√©', 'Quantit√©', 'PU (DH)', 'Montant (DH)'],
            ...exportData
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Bordereau");
        XLSX.writeFile(wb, "bordereau_{{ lot.nom|slugify }}.xlsx");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const exportData = hot.getData().filter(row => row && row[1] !== null && row[1] !== '');
        const headers = ['N¬∞', 'D√©signation', 'Unit√©', 'Quantit√©', 'PU (DH)', 'Montant (DH)'];
        const body = exportData.map(row => row.map(cell => {
            if(typeof cell === 'number') {
                return cell.toLocaleString('fr-FR', { minimumFractionDigits: 2 });
            }
            return cell || '';
        }));
        doc.text("Bordereau des prix unitaires - {{ lot.nom }}", 14, 15);
        doc.autoTable({
            head: [headers],
            body: body,
            startY: 20,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 123, 255] }
        });
        doc.save("bordereau_{{ lot.nom|slugify }}.pdf");
    }

</script>
<style>
    /* ===== STYLES G√âN√âRAUX HANDSONTABLE ===== */      
.handsontable-custom {
    background: transparent !important;
    border: none !important;
    font-family: 'Segoe UI', system-ui, sans-serif !important;
}
.handsontable-custom .montant-cell {
    font-weight: 600 !important;
    color: #34D399 !important;
    font-size: 13px !important;
}   
.handsontable-custom .title-row {
    background: #1F2937 !important;
    font-weight: 700 !important;
    color: #FBBF24 !important;
    font-size: 13px !important;
}

/* ===== EN-T√äTES DE COLONNES ===== */
.handsontable-custom thead th {
    background: #374151 !important;
    color: #22d3ee !important;
    border:none !important;
    border-right: 1px solid rgba(144, 161, 185, 0.15) !important; 
    font-weight: 600 !important;
    font-size: 13px !important;
    text-transform: uppercase !important;
    /* min-height: 35px !important; */
    height: 45px !important;
    text-align: center !important;
    vertical-align: middle !important;
} 

/* ===== CORPS DU TABLEAU ===== */
.handsontable-custom tbody td {
    background: #3B3B3B !important;
    border: 1px solid rgba(144, 161, 185, 0.15) !important; 
    color: #E5E7EB !important;
    transition: all 0.2s ease !important;
    vertical-align: middle !important;
    font-size: 12px !important;
}

/* Alternance des lignes */
.handsontable-custom tbody tr:nth-child(even) td {
    background: #363636;
}
 .toggle-triangle {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
    vertical-align: middle; 
    line-height: 1;
}

.triangle-collapsed::before {
    display: inline-block;
    content: "‚ñ∂ ";
    color: #22d3ee;
    font-size: 10px;
}

.triangle-expanded::before {
    display: inline-block;
    content: "‚ñº ";
    color: #22d3ee;
    font-size: 10px;
} 
.indentation-controls {
    margin-bottom: 10px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.indentation-controls button {
    padding: 8px 12px;
    margin-right: 10px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    border-radius: 3px;
}

.indentation-controls button:hover:not(:disabled) {
    background: #e9e9e9;
}

.indentation-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
</body>
</html>