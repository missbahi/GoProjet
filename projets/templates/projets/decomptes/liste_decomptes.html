<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    {% load static %}
    {% load formatters %}
    <title>Décomptes – {{ projet.nom }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <style>
        body { background-color: #2E2E2E; color: #AECBD6; font-family: Arial, sans-serif; }
        .decompte-card { 
            background: #3B3B3B; 
            border: 1px solid #4B5563; 
            border-radius: 8px; 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
            transition: all 0.3s ease; 
        }
        .decompte-card:hover { 
            border-color: #22d3ee; 
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1); 
            transform: translateY(-2px);
        }
        .btn-primary { background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); border: none; color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; }
        .btn-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); border: none; color: white; }
        .form-control { 
            background-color: #2E2E2E; 
            border: 1px solid #4B5563; 
            color: #AECBD6; 
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .form-control:focus { 
            border-color: #22d3ee; 
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2); 
            outline: none;
        }       
        .statut-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }     
        .type-decompte-badge { 
            display: inline-block; 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.375rem; 
            font-size: 0.75rem; 
            font-weight: 600; 
            margin-right: 0.5rem;
        }

        .formulaire-decompte {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            background: #3B3B3B;
            border: 1px solid #4B5563;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        /* État EXPANDÉ (visible) */
        .formulaire-decompte.expanded {
            max-height: none; /* Supprimer la limite de hauteur */
            opacity: 1;
            padding: 1.5rem;
            border: 1px solid #4B5563;
            margin-bottom: 1rem;
            overflow: visible; /* Permettre le défilement naturel */
        }

        .formulaire-decompte.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border: none;
            margin-bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
      
        .formulaire-decompte:focus-within {
            border-color: #22d3ee;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }
        
        .form-control.auto-focused {
            animation: pulseFocus 2s ease-in-out;
        }      
        @keyframes pulseFocus {
            0% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); }
        }        
        .montant-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }        
        .retard-badge {
            animation: pulse 2s infinite;
        }       
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }       
        .alert-auto-dismiss {
            animation: fadeOut 5s forwards;
        }       
        @keyframes fadeOut {
            0% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }       
        .alert-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .alert-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .alert-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .alert-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; }
        .auto-expand-form {
            border-left: 4px solid #8b5cf6;
            animation: slideInContext 0.5s ease-out;
        }
        @keyframes slideInContext {
            from { 
                opacity: 0;
                transform: translateX(-10px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        .context-indicator {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
        }
        .btn-disabled {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
            color: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-disabled:hover {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
            transform: none;
            box-shadow: none;
        }

        /* Optimisations responsive */
        .btn-navigation {
            background: #4B5563;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 14px;
        }

        .btn-navigation:hover {
            background: #374151;
        }

        .btn-amber {
            background: #d97706;
        }

        .btn-amber:hover {
            background: #b45309;
        }

        .btn-purple {
            background: #7c3aed;
        }

        .btn-purple:hover {
            background: #6d28d9;
        }

        .navigation-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filtres-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filtre-btn {
            background: #3B3B3B;
            color: #AECBD6;
            border: 1px solid #4B5563;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filtre-btn:hover {
            border-color: #22d3ee;
        }

    @media (max-width: 768px) {
            .formulaire-decompte {
                padding: 1rem;
            }
            
            .formulaire-decompte.expanded {
                padding: 1rem;
            }
            
            /* Ajuster les grilles pour mobile */
            .formulaire-decompte .grid {
                gap: 0.75rem;
            }
            
            /* Assurer que les champs soient bien visibles */
            .formulaire-decompte input,
            .formulaire-decompte select,
            .formulaire-decompte textarea {
                font-size: 16px; /* Éviter le zoom automatique sur iOS */
                min-height: 44px; /* Taille tactile minimale */
            }
            
            /* Adapter les boutons pour mobile */
            .formulaire-decompte .flex-wrap {
                justify-content: center;
                gap: 0.5rem;
            }
            
            .formulaire-decompte button,
            .formulaire-decompte a {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 14px;
            }
        }
    @media (max-width: 480px) {
        .formulaire-decompte {
            padding: 0.75rem;
            margin-left: -0.5rem;
            margin-right: -0.5rem;
            border-left: none;
            border-right: none;
            border-radius: 0;
        }
        
        .formulaire-decompte.expanded {
            padding: 0.75rem;
            border-left: none;
            border-right: none;
            border-radius: 0;
        }
        
        /* Stack vertical pour les petits écrans */
        .formulaire-decompte .grid {
            grid-template-columns: 1fr !important;
        }
        
        /* Agrandir les zones de saisie */
        .formulaire-decompte textarea {
            min-height: 100px;
        }
    }

<style>
/* Conteneur principal pour les champs avec suffixe */
.field-with-suffix {
    position: relative;
    width: 100%;
}

/* Style de base pour tous les inputs */
.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    color: white;
    font-size: 1rem;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-sizing: border-box;
}

/* Pour les champs numériques uniquement - alignement à droite */
.form-control[type="number"],
input.form-control.text-right {
    text-align: right;
    padding-right: 3rem !important; /* Espace pour le suffixe */
    direction: ltr; /* Garantir l'ordre gauche-droite des nombres */
}

/* Effet focus */
.form-control:focus {
    outline: none;
    border-color: #06b6d4;
    box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    background: rgba(255, 255, 255, 0.08);
}

/* Placeholder */
.form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Style du suffixe */
.field-with-suffix .suffix {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.5);
    pointer-events: none; /* Ne pas interférer avec les clics */
    font-size: 0.875rem;
    font-weight: 500;
    z-index: 5;
    background: transparent;
    padding: 0 0.25rem;
}

/* Style spécifique pour les inputs number */
.form-control[type="number"] {
    -moz-appearance: textfield; /* Firefox */
}

/* Chrome, Safari, Edge, Opera - masquer les flèches */
.form-control[type="number"]::-webkit-outer-spin-button,
.form-control[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Style pour les champs avec erreur */
.form-control.error {
    border-color: #f87171;
    box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2);
}

/* Style pour les champs désactivés */
.form-control:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgba(255, 255, 255, 0.03);
}

/* Label stylisé */
.form-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #38bdf8;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-label.required:after {
    content: " *";
    color: #f87171;
}

/* Helper text */
.helper-text {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.75rem;
    margin-top: 0.375rem;
}

/* Messages d'erreur */
.error-message {
    color: #f87171;
    font-size: 0.875rem;
    margin-top: 0.375rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.error-message:before {
    content: "⚠";
    font-size: 0.875rem;
}

/* Animation subtile au focus */
@keyframes subtlePulse {
    0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); }
    70% { box-shadow: 0 0 0 4px rgba(6, 182, 212, 0); }
    100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
}

.form-control:focus {
    animation: subtlePulse 0.6s ease;
}

/* Style pour le groupe de formulaire */
.form-group {
    margin-bottom: 1.5rem;
}

/* Responsive adjustments */
@media (max-width: 640px) {
    .form-control {
        padding: 0.625rem 0.875rem;
        font-size: 0.9375rem;
    }
    
    .field-with-suffix .suffix {
        right: 0.875rem;
        font-size: 0.8125rem;
    }
    
    .form-control[type="number"],
    input.form-control.text-right {
        padding-right: 2.5rem !important;
    }
}

/* Dark mode optimization */
@media (prefers-color-scheme: dark) {
    .form-control[type="date"],
    .form-control[type="number"] {
        color-scheme: dark;
    }
}

/* Hover effect (optionnel) */
.form-control:not(:disabled):hover {
    border-color: rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.07);
}

/* Style pour les valeurs valides/invalides */
.form-control:valid:not(:placeholder-shown) {
    border-color: rgba(16, 185, 129, 0.3);
}

.form-control:invalid:not(:placeholder-shown) {
    border-color: rgba(248, 113, 113, 0.3);
}
</style>

<style>
/* Style spécifique pour les selects */
select.form-control {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23cbd5e1' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 1rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    padding-right: 2.5rem;
    cursor: pointer;
    
    /* Texte visible */
    color: white !important;
    background-color: rgba(255, 255, 255, 0.05) !important;
}

/* Style pour les options dans le dropdown */
select.form-control option {
    color: white !important;
    background-color: #1e293b !important; /* Couleur sombre pour le dropdown */
    padding: 0.5rem;
}

/* Style pour le placeholder/option par défaut */
select.form-control option[value=""] {
    color: rgba(255, 255, 255, 0.5) !important;
}

/* Hover sur les options */
select.form-control option:hover,
select.form-control option:focus,
select.form-control option:checked {
    background-color: #0f172a !important;
    color: #38bdf8 !important;
}

/* Style pour le select au focus */
select.form-control:focus {
    border-color: #06b6d4;
    box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    background-color: rgba(255, 255, 255, 0.08) !important;
}

/* Style pour le select désactivé */
select.form-control:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: rgba(255, 255, 255, 0.03) !important;
}

/* Correction pour Firefox */
@-moz-document url-prefix() {
    select.form-control {
        text-indent: 0.01px;
        text-overflow: '';
        padding-right: 2rem;
    }
    
    select.form-control option {
        background-color: #1e293b;
        color: white;
    }
}

/* Correction pour Safari */
@media not all and (min-resolution: 0.001dpcm) {
    select.form-control {
        -webkit-appearance: menulist;
    }
}

/* Style pour les selects dans les groupes de formulaire */
.form-group select.form-control {
    width: 100%;
}
</style>

</head>
<body class="p-4 sm:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- L'en-tête -->
        {% if from_attachement_list and attachement_cible %}
        <div class="mb-4 p-4 bg-purple-900/30 border border-purple-500 rounded-lg">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-contract text-purple-400 text-xl"></i>
                    <div>
                        <span class="text-purple-300 font-medium">Contexte : </span>
                        <span class="text-white">
                            {% if action_type == 'modifier' %}
                            Modification du décompte
                            {% elif action_type == 'ajouter' %}
                            Ajout d'un décompte
                            {% endif %}
                            pour l'attachement
                        </span>
                        <span class="bg-purple-600 text-white px-3 py-1 rounded-lg text-sm ml-2 font-mono">
                            {{ attachement_cible.numero }}
                        </span>
                    </div>
                </div>
                <div class="text-sm text-purple-300">
                    <i class="fas fa-calendar-alt mr-1"></i>
                    Période : {{ attachement_cible.date_fin_periode|date:"d/m/Y" }}
                </div>
            </div>
            
            {% if action_type == 'ajouter' %}
            <div class="mt-3 pt-3 border-t border-purple-400/30">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-400"></i>
                        <span class="text-green-300">Attachement présélectionné</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-calendar-day text-blue-400"></i>
                        <span class="text-blue-300">Date d'émission : Aujourd'hui</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-hourglass-end text-amber-400"></i>
                        <span class="text-amber-300">Échéance : Date fin de période</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Section des boutons de navigation - TOUJOURS VISIBLES -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <!-- Boutons de gauche -->
            <div class="navigation-container">
                <a href="{% url 'home' %}" class="btn-navigation">
                    <i class="fas fa-house"></i> Accueil
                </a>
                <a href="{% url 'projets:liste_projets' %}" class="btn-navigation">
                    <i class="fas fa-arrow-left"></i> Retour aux projets
                </a>
                <a href="{% url 'projets:dashboard' projet.id %}" class="btn-navigation btn-amber">
                    <i class="fas fa-diagram-project"></i> Tableau de bord
                </a>
                <a href="{% url 'projets:liste_attachements' projet.id %}" class="btn-navigation btn-purple">
                    <i class="fas fa-file-contract"></i> Attachements
                </a>
            </div>
            
            <!-- Bouton à droite -->
            {% if decompte_a_modifier or attachements_disponibles_count > 0 %}
            <button id="toggle-form-btn" 
                    class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white font-medium flex items-center gap-2 transition-colors whitespace-nowrap">
                <span id="toggle-form-text">
                    {% if not decomptes %}Ajouter le premier décompte{% else %}Ajouter un décompte{% endif %}
                </span>
                <i id="toggle-form-icon" class="fas fa-chevron-down transition-transform"></i>
            </button>
            {% else %}
            <div class="px-4 py-2 rounded-lg bg-gray-600 text-gray-300 font-medium flex items-center gap-2 cursor-not-allowed whitespace-nowrap" 
                title="Aucun attachement disponible pour créer un décompte">
                <span>Aucun attachement disponible</span>
                <i class="fas fa-ban"></i>
            </div>
            {% endif %}
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for message in messages %}
                    <div class="alert-auto-dismiss p-4 rounded-lg alert-{{ message.tags }} flex justify-between items-center">
                        <span>{{ message }}</span>
                        <button type="button" onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Informations projet -->
        <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-4 sm:p-6 mb-6">
            <h2 class="text-lg sm:text-xl font-semibold text-cyan-300 mb-4">{{ projet.nom }}</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Numéro de marché :</strong> {{ projet.numero }}</p>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Objet :</strong> {{ projet.objet }}</p>
                </div>
                <div>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Maître d'ouvrage :</strong> {{ projet.maitre_ouvrage }}</p>
                    <p class="text-gray-400">
                        <strong class="text-[#AECBD6]">Statut :</strong> 
                        <span class="bg-[#4B5563] text-white px-2 py-1 rounded text-xs">{{ projet.get_statut_display }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Résumé financier -->
        {% if decomptes %}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6">
            <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-3 sm:p-4 text-center">
                <div class="text-cyan-400 text-xs sm:text-sm mb-1">Total HT</div>
                <div class="text-base sm:text-xl font-bold text-white">
                    {{ decomptes_total_ht|default:0|format_quantity }} DH
                </div>
            </div>
            <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-3 sm:p-4 text-center">
                <div class="text-cyan-400 text-xs sm:text-sm mb-1">Total TTC</div>
                <div class="text-base sm:text-xl font-bold text-white">
                    {{ decomptes_total_ttc|default:0|format_quantity }} DH
                </div>
            </div>
            <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-3 sm:p-4 text-center">
                <div class="text-cyan-400 text-xs sm:text-sm mb-1">Net à Payer</div>
                <div class="text-base sm:text-xl font-bold text-white">
                    {{ decomptes_total_net|default:0|format_quantity }} DH
                </div>
            </div>
            <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-3 sm:p-4 text-center">
                <div class="text-cyan-400 text-xs sm:text-sm mb-1">Décomptes Payés</div>
                <div class="text-base sm:text-xl font-bold text-white">
                    {{ decomptes_payes_count|default:0 }}/{{ decomptes.count }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filtres par statut -->
        <div class="filtres-container">
            <a href="?statut=PAYE" class="filtre-btn">
                Payés ({{ decomptes_payes.count }})
            </a>
            <a href="?statut=EMIS" class="filtre-btn">
                Émis ({{ decomptes_emis.count }})
            </a>
            <a href="?statut=VALIDE" class="filtre-btn">
                Validés ({{ decomptes_valides.count }})
            </a>
            <a href="?statut=BROUILLON" class="filtre-btn">
                Brouillons ({{ decomptes_brouillons.count }})
            </a>
            <a href="?" class="filtre-btn">
                Tous ({{ decomptes.count }})
            </a>
        </div>

        <!-- Liste des décomptes -->
        {% if decomptes %}
            <div class="grid gap-4 mb-6">
                {% for decompte in decomptes %}
                <div class="decompte-card">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="type-decompte-badge 
                                    {% if decompte.type_decompte == 'PROVISOIRE' %}bg-blue-600
                                    {% elif decompte.type_decompte == 'DEFINITIF' %}bg-green-600
                                    {% else %}bg-purple-600{% endif %}">
                                    {{ decompte.get_type_decompte_display }}
                                </span>
                                <span class="statut-badge 
                                    {% if decompte.statut == 'PAYE' %}bg-green-900 text-green-300
                                    {% elif decompte.statut == 'VALIDE' %}bg-blue-900 text-blue-300
                                    {% elif decompte.statut == 'EMIS' %}bg-yellow-900 text-yellow-300
                                    {% elif decompte.statut == 'EN_RETARD' %}bg-red-900 text-red-300
                                    {% elif decompte.statut == 'PARTIEL' %}bg-orange-900 text-orange-300
                                    {% else %}bg-gray-700 text-gray-300{% endif %}">
                                    {{ decompte.get_statut_display }}
                                </span>
                                {% if decompte.est_en_retard %}
                                <span class="retard-badge bg-red-500 text-white text-xs px-2 py-1 rounded" title="En retard de paiement">
                                    <i class="fas fa-exclamation-triangle"></i> Retard
                                </span>
                                {% endif %}
                            </div>
                            <h3 class="text-lg sm:text-xl font-semibold text-cyan-300">{{ decompte.numero }}</h3>
                            <p class="text-[#2B9C62] font-medium">Attachement: {{ decompte.attachement.numero }}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                            <a href="{% url 'projets:detail_decompte' decompte.id %}" 
                               class="btn-info px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-eye"></i> Détails
                            </a>
                            {% if decompte.statut != 'PAYE' %}
                            <a href="{% url 'projets:liste_decomptes' projet.id %}?modifier={{ decompte.id }}{% if from_attachement_list %}&from_attachements=true&attachement_id={{ decompte.attachement.id }}&action=modifier{% endif %}" 
                                class="btn-warning px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-edit"></i> Modifier
                                </a>
                            <a href="{% url 'projets:supprimer_decompte' decompte.id %}" 
                               class="btn-danger px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center gap-2 whitespace-nowrap"
                               onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce décompte?')">
                                <i class="fas fa-trash"></i> Supprimer
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Informations financières -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-xs sm:text-sm text-gray-400 mb-3">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-money-bill"></i>
                            <span>HT: {{ decompte.montant_situation_ht|format_quantity }} DH</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-percentage"></i>
                            <span>TVA: {{ decompte.montant_situation_tva|format_quantity }} DH</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calculator"></i>
                            <span>TTC: {{ decompte.montant_situation_ttc|format_quantity }} DH</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="font-semibold text-white">Net: {{ decompte.montant_situation_net_a_payer|format_quantity }} DH</span>
                        </div>
                    </div>

                    <!-- Informations supplémentaires -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-xs sm:text-sm text-gray-400">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar"></i>
                            <span>Émission: {{ decompte.date_emission|date:"d/m/Y" }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-hourglass-end"></i>
                            <span>Échéance: {{ decompte.date_echeance|date:"d/m/Y"|default:"-" }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>
                                {% if decompte.numero_bordereau %}
                                    Bordereau: {{ decompte.numero_bordereau }}
                                {% else %}
                                    Sans bordereau
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar-check"></i>
                            <span>
                                {% if decompte.date_paiement %}
                                    Payé le: {{ decompte.date_paiement|date:"d/m/Y" }}
                                {% else %}
                                    Non payé
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Retenues -->
                    {% if decompte.montant_retenue_garantie or decompte.montant_ras or decompte.autres_retenues %}
                    <div class="mt-3 pt-3 border-t border-gray-600">
                        <div class="text-xs sm:text-sm text-amber-400 font-semibold mb-2">Retenues appliquées:</div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs">
                            {% if decompte.montant_retenue_garantie %}
                            <div>Garantie: {{ decompte.montant_situation_retenue_garantie|format_quantity }} DH ({{ decompte.taux_retenue_garantie }}%)</div>
                            {% endif %}
                            {% if decompte.montant_ras %}
                            <div>RAS: {{ decompte.montant_situation_ras|format_quantity }} DH ({{ decompte.taux_ras }}%)</div>
                            {% endif %}
                            {% if decompte.autres_retenues %}
                            <div>Autres: {{ decompte.montant_situation_autres_retenues|format_quantity }} DH</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-6 sm:p-8 text-center mb-6">
                <i class="fas fa-calculator text-4xl sm:text-6xl text-gray-500 mb-4"></i>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-400 mb-2">Aucun décompte</h3>
                <p class="text-gray-500">Commencez par ajouter un décompte pour ce projet.</p>
            </div>
        {% endif %}

        <!-- Formulaire de décompte -->
         {% if decompte_a_modifier or attachements_disponibles_count > 0 %}
        <div id="formulaire-decompte" 
            class="formulaire-decompte {% if not decomptes %}expanded{% else %}collapsed{% endif %}">
            <h3 class="text-lg sm:text-xl font-semibold text-cyan-300 mb-4 flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> 
                {% if decompte_a_modifier %}
                    Modifier le décompte
                {% else %}
                    Ajouter un nouveau décompte
                {% endif %}
            </h3>
            
            <form method="POST" class="space-y-4">
                {% csrf_token %}
                
                {% if decompte_a_modifier %}
                <input type="hidden" name="decompte_id" value="{{ decompte_a_modifier.id }}">
                {% endif %}
                
                <!-- Attachement et Numéro de décompte -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.attachement.id_for_label }}" class="block text-sm font-medium text-[#AECBD6] mb-2">
                            Attachement *
                        </label>
                        {{ form.attachement }}
                        {% if form.attachement.errors %}
                        <div class="text-red-400 text-sm mt-1">
                            {{ form.attachement.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.numero.id_for_label }}" class="block text-sm font-medium text-[#AECBD6] mb-2">
                            Numéro de décompte *
                        </label>
                        {{ form.numero }}
                        {% if form.numero.errors %}
                        <div class="text-red-400 text-sm mt-1">
                            {{ form.numero.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Type de décompte et statut -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.type_decompte.id_for_label }}" class="block text-sm font-medium text-[#AECBD6] mb-2">
                            Type de décompte *
                        </label>
                        {{ form.type_decompte }}
                        {% if form.type_decompte.errors %}
                        <div class="text-red-400 text-sm mt-1">
                            {{ form.type_decompte.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.statut.id_for_label }}" class="block text-sm font-medium text-[#AECBD6] mb-2">
                            Statut *
                        </label>
                        {{ form.statut }}
                        {% if form.statut.errors %}
                        <div class="text-red-400 text-sm mt-1">
                            {{ form.statut.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- SECTION EN DEUX COLONNES POUR LES DATES ET MONTANTS -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                    
                    <!-- COLONNE DE GAUCHE - DATES -->
                    <div class="space-y-6">
                        <!-- Date d'émission -->
                        <div>
                            <label for="{{ form.date_emission.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Date d'émission *
                            </label>
                            {{ form.date_emission }}
                            {% if form.date_emission.errors %}
                            <div class="text-red-400 text-sm mt-1">
                                {{ form.date_emission.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Date d'échéance -->
                        <div>
                            <label for="{{ form.date_echeance.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Date d'échéance
                            </label>
                            {{ form.date_echeance }}
                            {% if form.date_echeance.errors %}
                            <div class="text-red-400 text-sm mt-1">
                                {{ form.date_echeance.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Date de paiement -->
                        <div>
                            <label for="{{ form.date_paiement.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Date de paiement
                            </label>
                            {{ form.date_paiement }}
                            {% if form.date_paiement.errors %}
                            <div class="text-red-400 text-sm mt-1">
                                {{ form.date_paiement.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Autres retenues -->
                        <div>
                            <label for="{{ form.autres_retenues.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Autres retenues
                            </label>
                            <div class="field-with-suffix">
                                {{ form.autres_retenues }}
                                <span class="suffix">DH</span>
                            </div>
                            {% if form.autres_retenues.errors %}
                            <div class="text-red-400 text-sm mt-1">
                                {{ form.autres_retenues.errors }}
                            </div>
                            {% endif %}
                            <p class="helper-text mt-1">Montant additionnel en dirhams</p>
                        </div>
                    </div>
                    
                    <!-- COLONNE DE DROITE - MONTANTS ET RÉVISION -->
                    <div class="space-y-6">
                        <!-- Taux TVA -->
                        <div>
                            <label for="{{ form.taux_tva.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Taux TVA *
                            </label>
                            <div class="field-with-suffix">
                                {{ form.taux_tva }}
                                <span class="suffix">%</span>
                            </div>
                            {% if form.taux_tva.errors %}
                            <div class="error-message mt-1">
                                {{ form.taux_tva.errors }}
                            </div>
                            {% endif %}
                            <p class="helper-text mt-1">Taux de TVA applicable (0-100%)</p>
                        </div>

                        <!-- Retenue garantie -->
                        <div>
                            <label for="{{ form.taux_retenue_garantie.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Retenue garantie *
                            </label>
                            <div class="field-with-suffix">
                                {{ form.taux_retenue_garantie }}
                                <span class="suffix">%</span>
                            </div>
                            {% if form.taux_retenue_garantie.errors %}
                            <div class="error-message mt-1">
                                {{ form.taux_retenue_garantie.errors }}
                            </div>
                            {% endif %}
                            <p class="helper-text mt-1">Taux de retenue de garantie (0-100%)</p>
                        </div>

                        <!-- Taux RAS -->
                        <div>
                            <label for="{{ form.taux_ras.id_for_label }}" class="block text-lg font-semibold text-cyan-300 mb-2">
                                Taux RAS *
                            </label>
                            <div class="field-with-suffix">
                                {{ form.taux_ras }}
                                <span class="suffix">%</span>
                            </div>
                            {% if form.taux_ras.errors %}
                            <div class="error-message mt-1">
                                {{ form.taux_ras.errors }}
                            </div>
                            {% endif %}
                            <p class="helper-text mt-1">Retenue à la source (0-100%)</p>
                        </div>

                        <!-- RÉVISION DES PRIX - DANS LA MÊME COLONNE QUE LES TAUX -->
                        <div>
                            <h4 class="text-lg font-semibold text-cyan-300 mb-4">Révision des prix</h4>
                            
                            <!-- Montant de révision -->
                            <div class="mb-4">
                                <label for="{{ form.montant_revision_prix.id_for_label }}" class="form-label">
                                    Montant de révision
                                </label>
                                
                                <div class="field-with-suffix">
                                    {{ form.montant_revision_prix }}
                                    <span class="suffix">DH</span>
                                </div>
                                
                                {% if form.montant_revision_prix.errors %}
                                <div class="error-message">
                                    {{ form.montant_revision_prix.errors }}
                                </div>
                                {% endif %}
                                
                                <p class="helper-text">Montant HT de la révision calculée</p>
                            </div>
                            
                            <!-- Boutons d'action -->
                            <!-- <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <button type="button" 
                                            id="calculer-revision-btn"
                                            class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
                                            {% if not decompte_a_modifier %}disabled{% endif %}
                                            title="{% if not decompte_a_modifier %}Veuillez d'abord sauvegarder le décompte{% else %}Calculer la révision des prix{% endif %}">
                                        <i class="fas fa-calculator"></i>
                                        <span class="truncate">Calculer automatiquement</span>
                                    </button>
                                    <p class="helper-text mt-2 text-xs">
                                        Calcule la révision selon les indices officiels
                                    </p>
                                </div>
                                
                                <div>
                                    <button type="button" 
                                            id="editer-revision-btn"
                                            class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
                                            {% if not decompte_a_modifier %}disabled{% endif %}
                                            title="{% if not decompte_a_modifier %}Veuillez d'abord sauvegarder le décompte{% else %}Éditer la révision de prix{% endif %}">
                                        <i class="fas fa-edit"></i>
                                        <span class="truncate">Éditer manuellement</span>
                                    </button>
                                    <p class="helper-text mt-2 text-xs">
                                        Ajuster manuellement la révision calculée
                                    </p>
                                </div>
                            </div> -->
                            
                            <!-- Message d'information si décompte non sauvegardé -->
                            <!-- {% if not decompte_a_modifier %}
                            <div class="mt-4 p-3 bg-yellow-900/30 border border-yellow-600 rounded-lg">
                                <div class="flex items-center gap-2 text-yellow-300 text-sm">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Veuillez d'abord sauvegarder le décompte pour calculer la révision.</span>
                                </div>
                            </div>
                            {% endif %} -->
                        </div>
                    </div>
                </div>
                
                <!-- Informations sur la révision calculée (affiché conditionnellement) -->
                <!-- {% if decompte_a_modifier and decompte_a_modifier.revision_prix %} -->
                <!-- <div id="info-revision" class="mt-6 p-4 bg-blue-900/30 border border-blue-500 rounded-lg"> -->
                    <!-- <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-line text-blue-400 text-xl"></i>
                            <h4 class="text-lg font-semibold text-blue-300">Révision de prix calculée</h4>
                        </div>
                        <span class="statut-badge 
                            {% if decompte_a_modifier.revision_prix.statut == 'VALIDE' %}bg-green-900 text-green-300
                            {% elif decompte_a_modifier.revision_prix.statut == 'CALCULE' %}bg-blue-900 text-blue-300
                            {% elif decompte_a_modifier.revision_prix.statut == 'MODIFIE' %}bg-amber-900 text-amber-300
                            {% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ decompte_a_modifier.revision_prix.get_statut_display }}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-percentage text-blue-400"></i>
                            <span class="text-gray-300">Taux calculé:</span>
                            <span class="font-bold text-white ml-2">
                                {{ decompte_a_modifier.revision_prix.taux_revision_calcule|floatformat:2 }}%
                            </span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calculator text-green-400"></i>
                            <span class="text-gray-300">Montant calculé:</span>
                            <span class="font-bold text-white ml-2">
                                {{ decompte_a_modifier.revision_prix.montant_revision_calcule|format_french_number }} DH
                            </span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-amber-400"></i>
                            <span class="text-gray-300">Montant validé:</span>
                            <span class="font-bold text-white ml-2">
                                {% if decompte_a_modifier.revision_prix.montant_revision_valide %}
                                    {{ decompte_a_modifier.revision_prix.montant_revision_valide|format_french_number }} DH
                                {% else %}
                                    Non validé
                                {% endif %}
                            </span>
                        </div>
                    </div> -->
                    
                    <!-- {% if decompte_a_modifier.revision_prix.motif_ajustement %}
                    <div class="mt-3 pt-3 border-t border-blue-400/30">
                        <div class="text-xs text-blue-300 font-semibold mb-1">Motif d'ajustement:</div>
                        <div class="text-sm text-gray-300 bg-blue-900/20 p-3 rounded">
                            {{ decompte_a_modifier.revision_prix.motif_ajustement }}
                        </div>
                    </div>
                    {% endif %} -->
                    
                    <!-- <div class="mt-4 flex justify-end">
                        <button type="button" 
                                onclick="ouvrirModalRevision()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <i class="fas fa-chart-bar"></i>
                            Voir les détails du calcul
                        </button>
                    </div> -->
                <!-- </div> -->
                <!-- {% endif %} -->

                <!-- Observations -->
                <div>
                    <label for="{{ form.observations.id_for_label }}" class="block text-sm font-medium text-[#AECBD6] mb-2">
                        Observations
                    </label>
                    {{ form.observations }}
                    {% if form.observations.errors %}
                    <div class="text-red-400 text-sm mt-1">
                        {{ form.observations.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Boutons -->
                <div class="flex flex-wrap gap-3 pt-4">
                    <button type="submit" 
                            class="bg-[#2B9C62] hover:bg-[#107C41] text-white px-4 sm:px-6 py-2 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-save"></i>
                        {% if decompte_a_modifier %}
                            Modifier le décompte
                        {% else %}
                            Ajouter le décompte
                        {% endif %}
                    </button>
                    <a href="{% url 'projets:liste_decomptes' projet.id %}" 
                    class="bg-[#6b7280] hover:bg-[#4b5563] text-white px-4 sm:px-6 py-2 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                </div>
            </form>
        </div>

        {% else %}
        <div class="bg-amber-900/30 border border-amber-500 rounded-lg p-4 sm:p-6 text-center">
            <i class="fas fa-exclamation-triangle text-amber-400 text-xl sm:text-2xl mb-3"></i>
            <h3 class="text-base sm:text-lg font-semibold text-amber-300 mb-2">Aucun attachement disponible</h3>
            <p class="text-amber-200 text-sm">Tous les attachements ont déjà un décompte associé.</p>
            <p class="text-amber-200 text-xs sm:text-sm mt-2">
                <a href="{% url 'projets:ajouter_attachement' projet.id %}" class="underline hover:text-amber-100">
                    Ajouter un nouvel attachement
                </a> pour créer un décompte.
            </p>
        </div>
        {% endif %}
        
        <!-- Modal d'édition de la révision des prix -->
        <div id="modal-revision" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto flex items-center justify-center p-4">
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-[#2E2E2E] border border-[#4B5563] rounded-lg shadow-xl w-full max-w-4xl">
                    <!-- En-tête du modal -->
                    <div class="flex justify-between items-center p-6 border-b border-[#4B5563]">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-line text-purple-400 text-xl"></i>
                            <h3 class="text-xl font-semibold text-white">Édition de la révision de prix</h3>
                        </div>
                        <button type="button" 
                                onclick="fermerModalRevision()"
                                class="text-gray-400 hover:text-white text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Contenu du modal -->
                    <div class="p-6">
                        <!-- Indicateur de chargement -->
                        <div id="loading-revision" class="hidden text-center py-8">
                            <i class="fas fa-spinner fa-spin text-cyan-400 text-3xl mb-4"></i>
                            <p class="text-gray-300">Calcul de la révision en cours...</p>
                        </div>
                        
                        <!-- Formulaire d'édition -->
                        <div id="form-revision-content" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Calcul automatique -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-cyan-300 mb-4">
                                        <i class="fas fa-robot"></i> Calcul automatique
                                    </h4>
                                    
                                    <div class="bg-[#3B3B3B] p-4 rounded-lg">
                                        <div class="mb-3">
                                            <label class="text-sm text-gray-400">Montant HT révisable</label>
                                            <div class="text-xl font-bold text-white" id="montant-revisable">
                                                0.00 DH
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="text-sm text-gray-400">Taux calculé</label>
                                            <div class="text-xl font-bold text-cyan-400" id="taux-calcule">
                                                0.00%
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm text-gray-400">Montant calculé</label>
                                            <div class="text-xl font-bold text-green-400" id="montant-calcule">
                                                0.00 DH
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" 
                                            onclick="calculerRevision()"
                                            class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                                        <i class="fas fa-calculator"></i>
                                        Recalculer automatiquement
                                    </button>
                                </div>
                                
                                <!-- Ajustement manuel -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-amber-300 mb-4">
                                        <i class="fas fa-edit"></i> Ajustement manuel
                                    </h4>
                                    
                                    <form id="form-ajustement-revision">
                                        <div class="space-y-4">
                                            <div>
                                                <label for="taux-manuel" class="form-label">
                                                    <i class="fas fa-percentage"></i>
                                                    Taux de révision
                                                </label>
                                                <div class="field-with-suffix">
                                                    <input type="number" 
                                                        id="taux-manuel" 
                                                        name="taux_manuel"
                                                        step="0.01"
                                                        min="-100"
                                                        max="100"
                                                        class="form-control text-right"
                                                        placeholder="0.00">
                                                    <span class="suffix">%</span>
                                                </div>
                                                <p class="helper-text">Taux ajusté manuellement</p>
                                            </div>
                                            
                                            <div>
                                                <label for="montant-manuel" class="form-label">
                                                    <i class="fas fa-money-bill"></i>
                                                    Montant de révision
                                                </label>
                                                <div class="field-with-suffix">
                                                    <input type="number" 
                                                        id="montant-manuel" 
                                                        name="montant_manuel"
                                                        step="0.01"
                                                        class="form-control text-right"
                                                        placeholder="0.00">
                                                    <span class="suffix">DH</span>
                                                </div>
                                                <p class="helper-text">Montant ajusté manuellement</p>
                                            </div>
                                            
                                            <div>
                                                <label for="motif-ajustement" class="form-label">
                                                    <i class="fas fa-comment"></i>
                                                    Motif d'ajustement
                                                </label>
                                                <textarea id="motif-ajustement" 
                                                        name="motif_ajustement"
                                                        class="form-control"
                                                        rows="3"
                                                        placeholder="Expliquez les raisons de l'ajustement..."></textarea>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Détails du calcul -->
                            <div id="details-calcul" class="mt-6 hidden">
                                <h4 class="text-lg font-semibold text-white mb-4">
                                    <i class="fas fa-list-alt"></i> Détails du calcul
                                </h4>
                                <div class="bg-[#3B3B3B] rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-[#2C3E50]">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Indice</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Valeur base</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Valeur courante</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Variation</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Coefficient</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase">Contribution</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableau-indices" class="divide-y divide-[#4B5563]">
                                            <!-- Les données seront injectées ici par JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pied du modal -->
                    <div class="flex justify-between items-center p-6 border-t border-[#4B5563]">
                        
                        <div class="flex gap-3 mr-2">
                            <button type="button" 
                                    onclick="fermerModalRevision()"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium">
                                Annuler
                            </button>
                            <button type="button" 
                                    onclick="appliquerRevision()"
                                    id="appliquer-revision-btn"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                                <i class="fas fa-check"></i>
                                Appliquer au décompte
                            </button>
                        </div>
                        <div class="text-sm text-gray-400">
                            <i class="fas fa-info-circle"></i>
                            La révision est calculée selon la formule officielle marocaine
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // =========================================================================
        // 1. INITIALISATION ET VÉRIFICATIONS
        // =========================================================================

        // Éléments principaux
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const toggleFormText = document.getElementById('toggle-form-text');
        const toggleFormIcon = document.getElementById('toggle-form-icon');
        const formulaireDecompte = document.getElementById('formulaire-decompte');
        
        // Variables de contexte
        const attachementsDisponibles = {{ attachements_disponibles_count }};
        const isModificationMode = {{ decompte_a_modifier|yesno:"true,false" }};
        const fromAttachementList = {{ from_attachement_list|yesno:"true,false" }};
        const actionType = "{{ action_type|default:'' }}";
        const hasDecomptes = {{ decomptes|yesno:"true,false" }};
        

        // CORRECTION : Ne bloquer que si on veut AJOUTER mais aucun attachement disponible
        if (attachementsDisponibles === 0 && !isModificationMode) {
            return;
        }
        

        // Vérifier que les éléments essentiels existent
        if (!toggleFormBtn || !formulaireDecompte) {
            console.error('❌ Éléments manquants pour la gestion du formulaire:', {
                toggleFormBtn: !!toggleFormBtn,
                formulaireDecompte: !!formulaireDecompte
            });
            return;
        }

        // =========================================================================
        // 2. GESTION PRINCIPALE DU FORMULAIRE
        // =========================================================================
        
        let isExpanded = formulaireDecompte.classList.contains('expanded');

        function updateFormState() {
            if (isExpanded) {
                // État EXPANDÉ
                formulaireDecompte.classList.remove('collapsed');
                formulaireDecompte.classList.add('expanded');
                
                if (toggleFormIcon) {
                    toggleFormIcon.classList.remove('fa-chevron-down');
                    toggleFormIcon.classList.add('fa-chevron-up');
                }
                if (toggleFormText) {
                    toggleFormText.textContent = hasDecomptes ? 'Masquer le formulaire' : 'Ajouter le premier décompte';
                }
            } else {
                // État COLLAPSÉ
                formulaireDecompte.classList.remove('expanded');
                formulaireDecompte.classList.add('collapsed');
                
                if (toggleFormIcon) {
                    toggleFormIcon.classList.remove('fa-chevron-up');
                    toggleFormIcon.classList.add('fa-chevron-down');
                }
                if (toggleFormText) {
                    toggleFormText.textContent = hasDecomptes ? 'Ajouter un décompte' : 'Ajouter le premier décompte';
                }
            }
        }

        // Gestion du clic sur le bouton toggle
        toggleFormBtn.addEventListener('click', function() {
            isExpanded = !isExpanded;
            updateFormState();
        });

        // =========================================================================
        // 3. OUVERTURE AUTOMATIQUE DANS LES CAS SPÉCIFIQUES
        // =========================================================================
        
        function ouvrirFormulaireAutomatiquement() {
            const doitOuvrir = isModificationMode || 
                            (fromAttachementList && (actionType === 'ajouter' || actionType === 'modifier'));
            
            if (doitOuvrir && !isExpanded) {
                // Forcer l'ouverture
                isExpanded = true;
                updateFormState();
                
                // Marquer visuellement le contexte
                if (isModificationMode) {
                    formulaireDecompte.classList.add('formulaire-modification');
                } else if (fromAttachementList) {
                    formulaireDecompte.classList.add('auto-expand-form');
                }
                
                // Configuration spécifique pour l'ajout depuis attachements
                if (fromAttachementList && actionType === 'ajouter') {
                    configurerAjoutDepuisAttachements();
                }
            }
        }

        // =========================================================================
        // 4. CONFIGURATION SPÉCIFIQUE POUR AJOUT DEPUIS ATTACHEMENTS
        // =========================================================================
        
        function configurerAjoutDepuisAttachements() {
            const attachementSelect = document.getElementById('{{ form.attachement.id_for_label }}');
            
            if (attachementSelect && !attachementSelect.disabled) {
                const validOptions = Array.from(attachementSelect.options).filter(opt => opt.value !== '');
                
                // Verrouiller la sélection si un seul choix valide
                if (validOptions.length === 1) {
                    // attachementSelect.disabled = true;
                    attachementSelect.classList.add('bg-gray-700', 'cursor-not-allowed', 'opacity-80');
                    
                    const container = attachementSelect.parentElement;
                    container.classList.add('relative');
                    
                    // Ajouter icône de verrouillage
                    if (!container.querySelector('.fa-lock')) {
                        const lockIcon = document.createElement('span');
                        lockIcon.className = 'absolute right-10 top-1/2 transform -translate-y-1/2 text-amber-400';
                        lockIcon.innerHTML = '<i class="fas fa-lock" title="Attachement présélectionné"></i>';
                        container.appendChild(lockIcon);
                    }
                }
            }
            
            // Focus sur le premier champ éditable
            setTimeout(() => {
                const premierChamp = document.querySelector('#formulaire-decompte input:not([disabled])');
                if (premierChamp) {
                    premierChamp.focus();
                    premierChamp.classList.add('auto-focused');
                    setTimeout(() => premierChamp.classList.remove('auto-focused'), 2000);
                }
            }, 800);
        }

        // =========================================================================
        // 5. INITIALISATION FINALE
        // =========================================================================
        
        // État initial
        updateFormState();
        
        // Ouvrir automatiquement si nécessaire
        ouvrirFormulaireAutomatiquement();

    });
    </script>

    <script>
        // =========================================================================
        // FONCTIONS POUR LA GESTION DE LA RÉVISION DES PRIX
        // =========================================================================

        // Variables globales
        let revisionEnCours = null;
        let decompteId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Récupérer l'ID du décompte s'il existe
            const decompteIdInput = document.querySelector('input[name="decompte_id"]');
            if (decompteIdInput) {
                decompteId = decompteIdInput.value;
            }
            
            // Configuration des boutons
            const calculerBtn = document.getElementById('calculer-revision-btn');
            const editerBtn = document.getElementById('editer-revision-btn');
            
            if (calculerBtn) {
                calculerBtn.addEventListener('click', function() {
                    if (decompteId) {
                        calculerRevisionApi();
                    }
                });
            }
            
            if (editerBtn) {
                editerBtn.addEventListener('click', function() {
                    if (decompteId) {
                        ouvrirModalRevision();
                    } else {
                        alert('Veuillez d\'abord sauvegarder le décompte avant de calculer la révision.');
                    }
                });
            }
            
            // Synchronisation des champs taux/montant
            const tauxInput = document.getElementById('taux-manuel');
            const montantInput = document.getElementById('montant-manuel');
            
            if (tauxInput && montantInput) {
                tauxInput.addEventListener('input', function() {
                    synchroniserChampsRevision();
                });
                
                montantInput.addEventListener('input', function() {
                    synchroniserChampsRevision();
                });
            }
        });

        // Fonction pour ouvrir le modal
        function ouvrirModalRevision() {
            if (!decompteId) {
                alert('Veuillez d\'abord sauvegarder le décompte avant de calculer la révision.');
                return;
            }
            
            const modal = document.getElementById('modal-revision');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Initialiser le modal avec les données existantes
            initialiserModalRevision();
        }

        // Fonction pour fermer le modal
        function fermerModalRevision() {
            const modal = document.getElementById('modal-revision');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
            
            // Réinitialiser le formulaire
            reinitialiserFormulaireRevision();
        }

        // Initialiser le modal avec les données existantes
        function initialiserModalRevision() {
            const loadingDiv = document.getElementById('loading-revision');
            const formContent = document.getElementById('form-revision-content');
            
            // Afficher le chargement
            loadingDiv.classList.remove('hidden');
            formContent.classList.add('hidden');
            
            // Récupérer les données de révision existantes
            fetch(`/api/decomptes/${decompteId}/revision/`)
                .then(response => response.json())
                .then(data => {
                    loadingDiv.classList.add('hidden');
                    formContent.classList.remove('hidden');
                    
                    revisionEnCours = data;
                    
                    // Mettre à jour l'interface
                    mettreAJourInterfaceRevision(data);
                    
                    // Si des détails existent, afficher le tableau
                    if (data.detail_calcul && data.detail_calcul.variations_indices) {
                        afficherDetailsCalcul(data.detail_calcul);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    loadingDiv.classList.add('hidden');
                    formContent.classList.remove('hidden');
                    
                    // Afficher un message d'erreur
                    const detailsDiv = document.getElementById('details-calcul');
                    detailsDiv.classList.remove('hidden');
                    detailsDiv.innerHTML = `
                        <div class="bg-red-900/30 border border-red-500 rounded-lg p-4">
                            <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                            <span class="text-red-300">Erreur lors du chargement des données de révision.</span>
                        </div>
                    `;
                });
        }

        // Calculer la révision via l'API
        function calculerRevisionApi() {
            const loadingDiv = document.getElementById('loading-revision');
            const formContent = document.getElementById('form-revision-content');
            
            // Afficher le chargement
            loadingDiv.classList.remove('hidden');
            formContent.classList.add('hidden');
            
            fetch(`/api/decomptes/${decompteId}/revision/calculer/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.classList.add('hidden');
                formContent.classList.remove('hidden');
                
                if (data.success) {
                    revisionEnCours = data.revision;
                    mettreAJourInterfaceRevision(data.revision);
                    
                    // Afficher les détails du calcul
                    if (data.revision.detail_calcul) {
                        afficherDetailsCalcul(data.revision.detail_calcul);
                    }
                    
                    // Mettre à jour le champ de formulaire principal
                    const champRevision = document.getElementById('{{ form.montant_revision_prix.id_for_label }}');
                    if (champRevision) {
                        const montant = data.revision.montant_revision_valide || data.revision.montant_revision_calcule;
                        champRevision.value = montant;
                    }
                    
                    // Afficher un message de succès
                    afficherMessage('Révision calculée avec succès !', 'success');
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                loadingDiv.classList.add('hidden');
                formContent.classList.remove('hidden');
                afficherMessage('Erreur lors du calcul de la révision: ' + error.message, 'error');
            });
        }

        // Mettre à jour l'interface avec les données de révision
        function mettreAJourInterfaceRevision(revision) {
            // Mettre à jour les valeurs calculées
            document.getElementById('montant-revisable').textContent = 
                formatMontant(revision.montant_HT_revisable) + ' DH';
            document.getElementById('taux-calcule').textContent = 
                formatTaux(revision.taux_revision_calcule) + '%';
            document.getElementById('montant-calcule').textContent = 
                formatMontant(revision.montant_revision_calcule) + ' DH';
            
            // Mettre à jour les champs d'ajustement
            const tauxValide = revision.taux_revision_valide || revision.taux_revision_calcule;
            const montantValide = revision.montant_revision_valide || revision.montant_revision_calcule;
            
            document.getElementById('taux-manuel').value = formatTauxInput(tauxValide);
            document.getElementById('montant-manuel').value = formatMontantInput(montantValide);
            document.getElementById('motif-ajustement').value = revision.motif_ajustement || '';
            
            // Afficher les détails si disponibles
            const detailsDiv = document.getElementById('details-calcul');
            if (revision.detail_calcul && revision.detail_calcul.variations_indices) {
                detailsDiv.classList.remove('hidden');
            }
        }

        // Afficher les détails du calcul
        function afficherDetailsCalcul(detailCalcul) {
            const tableau = document.getElementById('tableau-indices');
            tableau.innerHTML = '';
            
            const variations = detailCalcul.variations_indices;
            
            for (const [code, details] of Object.entries(variations)) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-[#4B5563]';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-300">${code}</td>
                    <td class="px-4 py-3 text-sm text-gray-300 text-right">${details.indice_base.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-300 text-right">${details.indice_courant.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-right ${details.variation >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${(details.variation * 100).toFixed(2)}%
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-300 text-right">${(details.coefficient * 100).toFixed(1)}%</td>
                    <td class="px-4 py-3 text-sm text-right ${details.contribution >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${(details.contribution * 100).toFixed(3)}%
                    </td>
                `;
                
                tableau.appendChild(row);
            }
            
            // Ajouter une ligne de total
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-[#2C3E50] font-bold';
            
            totalRow.innerHTML = `
                <td colspan="4" class="px-4 py-3 text-sm text-gray-300 text-right">Total variation:</td>
                <td colspan="2" class="px-4 py-3 text-sm text-cyan-400 text-right">
                    ${(detailCalcul.total_variation * 100).toFixed(3)}%
                </td>
            `;
            tableau.appendChild(totalRow);
            
            // Ajouter la ligne du coefficient K
            const kRow = document.createElement('tr');
            kRow.className = 'bg-[#2C3E50] font-bold';
            
            kRow.innerHTML = `
                <td colspan="4" class="px-4 py-3 text-sm text-gray-300 text-right">Coefficient K:</td>
                <td colspan="2" class="px-4 py-3 text-sm text-cyan-400 text-right">
                    ${(detailCalcul.coefficient_K * 100).toFixed(1)}%
                </td>
            `;
            tableau.appendChild(kRow);
            
            // Ajouter la ligne de variation finale
            const finalRow = document.createElement('tr');
            finalRow.className = 'bg-[#2C3E50] font-bold border-t border-[#4B5563]';
            
            finalRow.innerHTML = `
                <td colspan="4" class="px-4 py-3 text-sm text-gray-300 text-right">Variation finale:</td>
                <td colspan="2" class="px-4 py-3 text-sm ${detailCalcul.variation_finale >= 0 ? 'text-green-400' : 'text-red-400'} font-bold text-right">
                    ${(detailCalcul.variation_finale * 100).toFixed(3)}%
                </td>
            `;
            tableau.appendChild(finalRow);
        }

        // Synchroniser les champs taux et montant
        function synchroniserChampsRevision() {
            const tauxInput = document.getElementById('taux-manuel');
            const montantInput = document.getElementById('montant-manuel');
            const montantRevisable = revisionEnCours?.montant_HT_revisable || 0;
            
            if (!tauxInput || !montantInput) return;
            
            const taux = parseFloat(tauxInput.value) || 0;
            const montant = parseFloat(montantInput.value) || 0;
            
            // Si le taux change, mettre à jour le montant
            if (document.activeElement === tauxInput && montantRevisable > 0) {
                const nouveauMontant = montantRevisable * (taux / 100);
                montantInput.value = formatMontantInput(nouveauMontant);
            }
            // Si le montant change, mettre à jour le taux
            else if (document.activeElement === montantInput && montantRevisable > 0) {
                const nouveauTaux = (montant / montantRevisable) * 100;
                tauxInput.value = formatTauxInput(nouveauTaux);
            }
        }

        // Appliquer la révision au décompte
        function appliquerRevision() {
            const tauxInput = document.getElementById('taux-manuel');
            const montantInput = document.getElementById('montant-manuel');
            const motifInput = document.getElementById('motif-ajustement');
            
            const taux = parseFloat(tauxInput.value) || 0;
            const montant = parseFloat(montantInput.value) || 0;
            const motif = motifInput.value;
            
            // Validation
            if (montant === 0 && taux === 0) {
                afficherMessage('Veuillez saisir un taux ou un montant de révision.', 'warning');
                return;
            }
            
            // Désactiver le bouton pour éviter les doubles clics
            const btnAppliquer = document.getElementById('appliquer-revision-btn');
            btnAppliquer.disabled = true;
            btnAppliquer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Application...';
            
            // Envoyer les données au serveur
            fetch(`/api/decomptes/${decompteId}/revision/valider/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    taux_revision_valide: taux,
                    montant_revision_valide: montant,
                    motif_ajustement: motif
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    afficherMessage('Révision appliquée avec succès !', 'success');
                    
                    // Mettre à jour le champ de formulaire principal
                    const champRevision = document.getElementById('{{ form.montant_revision_prix.id_for_label }}');
                    if (champRevision) {
                        champRevision.value = montant;
                    }
                    
                    // Fermer le modal après un délai
                    setTimeout(() => {
                        fermerModalRevision();
                        // Rafraîchir la page pour voir les changements
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                afficherMessage('Erreur lors de l\'application de la révision: ' + error.message, 'error');
            })
            .finally(() => {
                // Réactiver le bouton
                btnAppliquer.disabled = false;
                btnAppliquer.innerHTML = '<i class="fas fa-check"></i> Appliquer au décompte';
            });
        }

        // Réinitialiser le formulaire de révision
        function reinitialiserFormulaireRevision() {
            const tauxInput = document.getElementById('taux-manuel');
            const montantInput = document.getElementById('montant-manuel');
            const motifInput = document.getElementById('motif-ajustement');
            
            if (tauxInput) tauxInput.value = '';
            if (montantInput) montantInput.value = '';
            if (motifInput) motifInput.value = '';
            
            revisionEnCours = null;
        }

        // Fonctions utilitaires
        function formatMontant(montant) {
            return parseFloat(montant).toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatTaux(taux) {
            return parseFloat(taux).toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatMontantInput(montant) {
            return parseFloat(montant).toFixed(2);
        }

        function formatTauxInput(taux) {
            return parseFloat(taux).toFixed(2);
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        function afficherMessage(message, type) {
            // Créer un élément de message
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-amber-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            
            messageDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(messageDiv);
            
            // Supprimer automatiquement après 5 secondes
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    </script>
    
    
</body>
</html>