<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Contrôle - {{ projet.nom }}</title>
    {% load static %}
    {% load formatters %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'projets/css/context-menu.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #2E2E2E;
            color: #AECBD6;
            font-family: Arial, sans-serif;
        }
        
        .fiche-container {
            background: #3B3B3B;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .fiche-header {
            background: #3B3B3B;
            color: #22d3ee;
            padding: 10px;
            border-radius: 8px;
        }
        
        .table-fiche {
            width: 100%;
            border-collapse: collapse;
            background: #3B3B3B;
            font-size: 12px;
        }
        
        .table-fiche th {
            background: #374151;
            color: #22d3ee;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #4B5563;
            border-bottom: 1px solid #4B5563;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }
        .table-fiche th:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #22d3ee;
        }
        
        .table-fiche td {
            padding: 10px 8px;
            border: 1px solid #4B5563;
            text-align: right;
        }
        
        .table-fiche td.text-left {
            text-align: left;
        }
        
        .table-fiche tr:nth-child(even) {
            background-color: #2E2E2E;
        }
        
        .lot-header {
            background: linear-gradient(135deg, #2B9C62 0%, #107C41 100%);
            color: white;
            font-weight: bold;
            font-size: 13px;
        }
        
        .sous-total {
            background: linear-gradient(135deg, #1a2a3a 0%, #0f172a 100%);
            color: #22d3ee;
            font-weight: 600;
        }
        
        .total-general {
            background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
            color: white;
            font-weight: 700;
            font-size: 13px;
        }
        
        .montant {
            color: #9a6a10; 
            font-weight: 700;
        }
        
        .delta-negatif {
            color: #EF4444;
            font-weight: 600;
        }
        
        .delta-positif {
            color: #2B9C62;
            font-weight: 600;
        }
        
        .pourcentage {
            font-weight: 600;
        }
        .is_title {
            font-weight: 600;
            color:#0ea5e9;
            font-size: 13px !important;
            text-align: center;
        }

        .selecteur-container {
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #4B5563;
        }
        
        .btn-impression {
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-impression:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        /* Optimisations responsive */
        .btn-navigation {
            background: #4B5563;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 14px;
        }

        .btn-navigation:hover {
            background: #374151;
        }

        .btn-amber {
            background: #d97706;
        }

        .btn-amber:hover {
            background: #b45309;
        }

        .btn-purple {
            background: #7c3aed;
        }

        .btn-purple:hover {
            background: #6d28d9;
        }

        .navigation-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .selecteur-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .selecteur-wrapper {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        @media (max-width: 767px) {
            .table-fiche {
                font-size: 10px;
            }
            
            .table-fiche th,
            .table-fiche td {
                padding: 6px 4px;
            }
            
            .fiche-header {
                padding: 8px;
            }
            
            .btn-navigation {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .table-fiche {
                font-size: 9px;
            }
            
            .table-fiche th,
            .table-fiche td {
                padding: 4px 2px;
            }
            
            .navigation-container {
                gap: 8px;
            }
            
            .btn-navigation {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .selecteur-container {
                padding: 12px;
            }
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .table-fiche tr:nth-child(even) {
                background-color: rgb(214, 214, 214) !important;
            }
            
            .table-fiche tr:nth-child(odd) {
                background-color: white !important;
            }
            
            body {
                background-color: white !important;
                color: black !important;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4">
    <div class="max-w-9xl mx-auto">
        
        <!-- En-tête de la fiche -->
        <div class="fiche-container mb-4">
            <div class="fiche-header">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="flex-1">
                        <h1 class="text-xl sm:text-2xl font-bold mb-2">FICHE DE CONTRÔLE</h1>
                        <div class="space-y-1 text-green-600">
                           <p class="flex items-center gap-2">
                                <i class="fas fa-project-diagram w-6 sm:w-8"></i>
                                <span class="font-semibold w-20 sm:w-40">Projet : </span> 
                                <span class="break-words">{{ projet.nom }}</span>
                            </p>
                            <p class="flex items-center gap-2">
                                <i class="fas fa-hashtag w-6 sm:w-8"></i>
                                <span class="font-semibold w-20 sm:w-40">N° Marché : </span> 
                                <span>{{ projet.numero }}</span>
                            </p>
                            <p class="flex items-center gap-2">
                                <i class="fas fa-building w-6 sm:w-8"></i>
                                <span class="font-semibold w-20 sm:w-40">Maître d'ouvrage : </span> 
                                <span class="break-words">{{ projet.maitre_ouvrage }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-base sm:text-lg font-semibold">Date: {% now "d/m/Y" %}</p>
                        <p class="text-xs sm:text-sm opacity-90">Fiche générée le {% now "d/m/Y à H:i" %}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons de navigation - TOUJOURS VISIBLES -->
        <div class="navigation-container no-print">
            <a href="{% url 'home' %}" class="btn-navigation">
                <i class="fas fa-house"></i> Accueil
            </a>
            <a href="{% url 'projets:liste_projets' %}" class="btn-navigation">
                <i class="fas fa-arrow-left"></i> Retour aux projets
            </a>
            <a href="{% url 'projets:dashboard' projet.id %}" class="btn-navigation btn-amber">
                <i class="fas fa-diagram-project"></i> Tableau de bord
            </a>
            <a href="{% url 'projets:liste_attachements' projet.id %}" class="btn-navigation btn-purple">
                <i class="fas fa-file-contract"></i> Attachements
            </a>
        </div>

        <!-- Sélecteur d'attachement -->
        <div class="selecteur-container no-print">
            <div class="selecteur-wrapper">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                    <label for="attachement-select" class="text-white font-semibold whitespace-nowrap">
                        <i class="fas fa-file-contract mr-2"></i>Sélectionner l'attachement:
                    </label>
                    <select id="attachement-select" class="bg-gray-700 text-white px-3 sm:px-4 py-2 rounded border border-gray-600 focus:border-cyan-400 focus:outline-none w-full sm:w-auto">
                        <option value="">-- Choisir un attachement --</option>
                        {% for att in attachements %}
                        <option value="{{ att.id }}" {% if attachement_courant and attachement_courant.id == att.id %}selected{% endif %}>
                            {{ att.numero }} - {{ att.date_etablissement|date:"d/m/Y" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button onclick="window.print()" class="btn-impression mt-3 sm:mt-0 w-full sm:w-auto text-center">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>

        {% if attachement_courant %}
        <!-- Tableau de contrôle -->
        <div class="fiche-container overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table-fiche">
                    <thead>
                        <tr>
                            <!-- Colonnes MARCHÉ -->
                            <th colspan="5" style="background: linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%); color: white;">
                                MARCHÉ
                            </th>
                            <!-- Colonnes RÉALISATION -->
                            <th colspan="6" style="background: linear-gradient(135deg, #2B9C62 0%, #107C41 100%); color: white;">
                                RÉALISATION
                            </th>
                            
                            <!-- Colonnes DELTA -->
                            <th colspan="3" style="background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); color: white;">
                                ÉCARTS
                            </th>
                        </tr>
                        <tr>
                            <th width="60">N°</th>
                            <th width="300">DÉSIGNATION DES PRESTATIONS</th>
                            <th width="60">UNITE</th>
                            <!-- Sous-colonnes MARCHÉ -->
                            <th width="80">QTE MARCHE</th>
                            <th width="120">MT MARCHE</th>
                            
                            <!-- Sous-colonnes RÉALISATION -->
                            <th width="80">QTE CUMUL.<br>S-1</th>
                            <th width="80">QTE PART.</th>
                            <th width="120">MT PART.</th>
                            <th width="80">QTE CUMUL S</th>
                            <th width="120">MT CUMUL. S</th>
                            
                            <!-- Sous-colonnes DELTA -->
                            <th width="80">QTE S - QTE M</th>
                            <th width="100">MT S - MT M</th>
                            <th width="60">%<br>réalisé</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lot_data in donnees_controle %}
                        <!-- En-tête du lot -->
                         {% if nb_lots %}
                        <tr class="lot-header">
                            <td colspan="15" class="text-left">
                                <i class="fas fa-cube mr-2"></i>LOT {{ lot_data.lot.numero }} - {{ lot_data.lot.nom }}
                            </td>
                        </tr>
                        {% endif %}
                        {% for ligne in lot_data.lignes %}
                        {% if not ligne.can_be_hidden %}
                        <tr class = "{% if ligne.is_title %}is_title{% endif %}">
                            <td class="text-left">{{ ligne.numero|default:"" }}</td>
                            <td class="text-left">{{ ligne.designation }}</td>
                            <td class="text-center">{{ ligne.unite|default:"" }}</td>
                            
                            <!-- Données MARCHÉ -->
                            <td>{{ ligne.quantite_marche|format_french_number }}</td>
                            <td class="montant">{{ ligne.montant_marche|format_french_number }}</td>
                            
                            <!-- Données RÉALISATION -->
                            <td>{{ ligne.quantite_s1|format_french_number }}</td>
                            <td>{{ ligne.quantite_partiel|format_french_number }}</td>
                            <td class="montant">{{ ligne.montant_partiel|format_french_number }}</td>
                            <td>{{ ligne.quantite_s|format_french_number }}</td>
                            <td class="montant">{{ ligne.montant_s|format_french_number }}</td>
                            
                            <!-- Données DELTA -->
                            <td class="{% if ligne.delta_quantite < 0 %}delta-negatif{% else %}delta-positif{% endif %}">
                                {{ ligne.delta_quantite|format_french_number }}
                            </td>
                            <td class="{% if ligne.delta_montant < 0 %}delta-negatif{% else %}delta-positif{% endif %}">
                                {{ ligne.delta_montant|format_french_number }}
                            </td>
                            <td class="pourcentage {% if ligne.pourcentage_realise < 100 %}delta-positif{% elif ligne.pourcentage_realise > 100 %}delta-negatif{% endif %}">
                                {% if not ligne.is_title %}
                                    {{ ligne.pourcentage_realise|format_percentage }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Sous-total du lot -->
                         {% if nb_lots %}
                        <tr class="sous-total">
                            <td colspan="3" class="text-left">
                                <strong>SOUS-TOTAL LOT {{ lot_data.lot.numero }} :</strong>
                            </td>

                            <td colspan="2" class="montant">{{ lot_data.total_lot.montant_marche|format_french_number }}</td>

                            <td colspan="3" class="montant">{{ lot_data.total_lot.montant_partiel|format_french_number }}</td>

                            <td colspan="2" class="montant">{{ lot_data.total_lot.montant_s|format_french_number }}</td>

                            
                            <td colspan="2" class="{% if lot_data.delta_montant < 0 %}delta-negatif{% else %}delta-positif{% endif %}">
                                {{ lot_data.total_lot.delta_montant|format_french_number }}
                            </td>
                            <td class="pourcentage {% if lot_data.total_lot.pourcentage_realise < 100 %}delta-positif{% elif lot_data.total_lot.pourcentage_realise > 100 %}delta-negatif{% endif %}">
                                {{ lot_data.total_lot.pourcentage_realise|format_percentage }}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Total général -->
                        <tr class="total-general">
                            <td colspan="3" class="text-left"><strong>TOTAL GÉNÉRAL</strong></td>
                            <td colspan="2" class="montant">{{ total_general.montant_marche|format_french_number }}</td>
                            <td colspan="3" class="montant">{{ total_general.montant_partiel|format_french_number }}</td>

                            <td colspan="2" class="montant">{{ total_general.montant_s|format_french_number }}</td>
         
                            <td colspan="2" class="{% if total_general.delta_montant < 0 %}delta-negatif{% else %}delta-positif{% endif %}">
                                {{ total_general.delta_montant|format_french_number }}
                            </td>
                            <td class="pourcentage {% if total_general.pourcentage_realise < 100 %}delta-positif{% elif total_general.pourcentage_realise > 100 %}delta-negatif{% endif %}">
                                {{ total_general.pourcentage_realise|format_percentage }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Informations de l'attachement -->
        <div class="fiche-container mt-6 no-print">
            <div class="p-4 border-l-4 border-cyan-400 bg-gray-800">
                <h3 class="text-cyan-400 font-semibold mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Informations de l'attachement {{ attachement_courant.numero }}
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-400">Attachement:</span>
                        <p class="text-white">{{ attachement_courant.numero }}</p>
                    </div>
                    <div>
                        <span class="text-gray-400">Date établissement:</span>
                        <p class="text-white">{{ attachement_courant.date_etablissement|date:"d/m/Y" }}</p>
                    </div>
                    <div>
                        <span class="text-gray-400">Période:</span>
                        <p class="text-white">
                            {{ attachement_courant.date_debut_periode|date:"d/m/Y" }} - 
                            {{ attachement_courant.date_fin_periode|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div>
                        <span class="text-gray-400">Statut:</span>
                        <p class="text-white">{{ attachement_courant.get_statut_display }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Message si aucun attachement sélectionné -->
        <div class="fiche-container text-center py-12">
            <i class="fas fa-file-contract text-cyan-400 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-cyan-400 mb-2">Aucun attachement sélectionné</h3>
            <p class="text-gray-400">Veuillez sélectionner un attachement dans la liste déroulante pour afficher la fiche de contrôle.</p>
        </div>
        {% endif %}
    </div>

    <!-- contextMenu -->
    <div id="contextMenu" class="context-menu hidden">
        <div class="context-menu-item" onclick="masquerLignesSelectionnees()">
            <i class="fas fa-eye-slash mr-2"></i>Masquer les lignes
        </div>
        <div class="context-menu-item" onclick="afficherLignesMasquees()">
            <i class="fas fa-eye mr-2"></i>Afficher lignes masquées
        </div>
        <div class="context-menu-item" onclick="supprimerLignesSelectionnees()">
            <i class="fas fa-trash mr-2"></i>Supprimer les lignes
        </div>
        <div class="context-menu-item" onclick="copierContenuLigne()">
            <i class="fas fa-copy mr-2"></i>Copier le contenu
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-submenu">
            <div class="context-menu-item" onclick="changerHauteurLigne('compact')">
                <i class="fas fa-compress mr-2"></i>Hauteur compacte
            </div>
            <div class="context-menu-item" onclick="changerHauteurLigne('normale')">
                <i class="fas fa-arrows-alt-v mr-2"></i>Hauteur normale
            </div>
            <div class="context-menu-item" onclick="changerHauteurLigne('large')">
                <i class="fas fa-expand mr-2"></i>Hauteur large
            </div>
        </div>
    </div>

<script>
    // Gestion du sélecteur d'attachement
    document.getElementById('attachement-select').addEventListener('change', function() {
        const attachementId = this.value;
        if (attachementId) {
            window.location.href = `?attachement_id=${attachementId}`;
        }
    });

    // Auto-impression si paramètre d'impression
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('imprimer') === 'true' && document.getElementById('attachement-select').value) {
        window.print();
    }
</script>
<!-- script du contextMenu -->
 <script src="{% static 'projets/js/contextMenu.js' %}"></script>
</body>
</html>