<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    {% load static %}
    {% load formatters %}
    <title>Attachements – {{ projet.nom }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <style>
        body { background-color: #2E2E2E; color: #AECBD6; font-family: Arial, sans-serif; }
        .document-card { 
            background: #3B3B3B; 
            border: 1px solid #4B5563; 
            border-radius: 8px; 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
            transition: all 0.3s ease; 
        }
        .document-card:hover { 
            border-color: #22d3ee; 
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1); 
            transform: translateY(-2px);
        }
        .btn-primary { background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%); border: none; color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; }
        .btn-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); border: none; color: white; }
        .form-control { 
            background-color: #2E2E2E; 
            border: 1px solid #4B5563; 
            color: #AECBD6; 
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .form-control:focus { 
            border-color: #22d3ee; 
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2); 
            outline: none;
        }
        
        /* Styles pour la recherche */
        #searchBox {
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
        }

        #searchBox.show {
            opacity: 1;
            transform: translateY(0);
        }

        #searchInput::placeholder {
            color: #6B7280;
        }

        .search-highlight {
            background-color: rgba(34, 211, 238, 0.2);
            border-radius: 2px;
            padding: 0 2px;
        }
        
        /* Animation pour le modal */
        .modal {
            transition: opacity 0.3s ease;
        }
        
        /* Style spécifique pour les tableaux */
        .table-container {
            background-color: #3B3B3B;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #4B5563;
        }
        
        .table-header {
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            border-bottom: 2px solid #22d3ee;
        }
        
        .table-row {
            transition: all 0.2s ease;
            border-bottom: 1px solid #4B5563;
        }
        
        /* .table-row:hover {
            background-color: rgba(34, 211, 238, 0.1);
            transform: translateX(2px);
        } */
        
        .montant-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            text-align: right;
        }
        
        .statut-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 8px 12px;
        }

        .sortable:hover {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            transform: translateY(-1px);
        }

        .sortable.active {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%);
            color: #22d3ee;
            font-weight: 600;
            border-left: 3px solid #22d3ee;
        }

        /* Messages flash */
        .alert-auto-dismiss {
            animation: fadeOut 5s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .alert-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .alert-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .alert-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .alert-info { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto">
        <!-- En-tête -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-cyan-400 mb-2 flex items-center gap-2">
                <i class="fas fa-file-contract"></i>
                Attachements
            </h1>
            <h2 class="text-xl text-[#2B9C62]">{{ projet.nom }}</h2>
            <div class="flex items-center mt-4 text-sm text-gray-400">
                <i class="fas fa-info-circle mr-2"></i>
                <span>Gestion des attachements du projet</span>
            </div>
        </div>

        <!-- Boutons navigation -->
        <div class="flex gap-3 mb-6 flex-wrap">
            <a href="{% url 'home' %}" class="bg-[#4B5563] hover:bg-[#374151] text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-house"></i> Accueil
            </a>
            <a href="{% url 'projets:liste_projets' %}" class="bg-[#4B5563] hover:bg-[#374151] text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Retour aux projets
            </a>
            <a href="{% url 'projets:dashboard' projet.id %}" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-diagram-project"></i> Tableau de bord
            </a>
            <button onclick="window.location.href='{% url 'projets:ajouter_attachement' projet.id %}'" 
                    class="btn-success px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-plus"></i> Ajouter un attachement
            </button>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for message in messages %}
                    <div class="alert-auto-dismiss p-4 rounded-lg alert-{{ message.tags }} flex justify-between items-center">
                        <span>{{ message }}</span>
                        <button type="button" onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Informations projet -->
        <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-cyan-300 mb-4">{{ projet.nom }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Numéro de marché :</strong> {{ projet.numero }}</p>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Objet :</strong> {{ projet.objet }}</p>
                </div>
                <div>
                    <p class="text-gray-400"><strong class="text-[#AECBD6]">Maître d'ouvrage :</strong> {{ projet.maitre_ouvrage }}</p>
                    <p class="text-gray-400">
                        <strong class="text-[#AECBD6]">Statut :</strong> 
                        <span class="bg-[#4B5563] text-white px-2 py-1 rounded text-xs">{{ projet.get_statut_display }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <!-- Bouton de recherche -->
                <div class="relative">
                    <button id="searchToggle" class="bg-[#4B5563] hover:bg-[#374151] text-white rounded-lg px-4 py-2 flex items-center">
                        <i class="fas fa-search mr-2"></i> Rechercher
                    </button>
                    
                    <!-- Champ de recherche (caché par défaut) -->
                    <div id="searchBox" class="hidden absolute left-0 top-12 bg-[#3B3B3B] border border-cyan-500 rounded-lg shadow-lg z-10 w-80">
                        <div class="p-3">
                            <div class="relative">
                                <input type="text" 
                                    id="searchInput" 
                                    placeholder="Rechercher numéros, statuts, montants..."
                                    class="w-full bg-[#2E2E2E] text-[#AECBD6] border border-cyan-500 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                                <i class="fas fa-search absolute right-3 top-3 text-cyan-400"></i>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">
                                Minimum 3 caractères. Recherche dans : numéros, statuts, montants.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compteur de résultats -->
                <div id="resultCount" class="text-cyan-400 text-sm hidden">
                    <span id="countValue">0</span> attachement(s) trouvé(s)
                </div>
            </div>

            <!-- Message d'information recherche -->
            <div id="searchInfo" class="text-cyan-300 text-xs mt-2 hidden">
                Recherche active : "<span id="searchTerm"></span>"
                <button id="clearSearch" class="ml-2 text-red-400 hover:text-red-300">
                    <i class="fas fa-times"></i> Effacer
                </button>
            </div>
        </div>

        <!-- Tableau des attachements -->
        <div class="table-container">
            {% if attachements %}
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="table-header">
                        <tr>
                            <th class="px-2 py-4 text-left text-cyan-400 font-semibold uppercase text-sm sortable" data-sort="numero">
                                Numéro
                            </th>
                            <th class="px-2 py-4 text-left text-cyan-400 font-semibold uppercase text-sm sortable" data-sort="date">
                                Date Attachement
                            </th>
                            <th class="px-2 py-4 text-left text-cyan-400 font-semibold uppercase text-sm sortable" data-sort="statut">
                                Statut
                            </th>
                            <th class="px-2 py-4 text-right text-cyan-400 font-semibold uppercase text-sm sortable" data-sort="montant">
                                Montant HT (DH)
                            </th>
                            <th class="px-2 py-4 text-left text-cyan-400 font-semibold uppercase text-sm">
                                Fichier d'attachement
                            </th>
                            <th class="px-2 py-4 text-center text-cyan-400 font-semibold uppercase text-sm">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for attachement in attachements %}
                        <tr class="table-row text-[#AECBD6]">
                            <td class="px-2 py-4 whitespace-nowrap font-medium">
                                {{ attachement.numero }}
                            </td>
                            <td class="px-2 py-4 whitespace-nowrap">
                                {{ attachement.date_fin_periode|date:"d/m/Y" }}
                            </td>
                            <td class="px-2 py-4 whitespace-nowrap">
                                <span class="statut-badge 
                                    {% if attachement.statut == 'Validé' %}bg-green-900 text-green-300
                                    {% elif attachement.statut == 'En attente' %}bg-yellow-900 text-yellow-300
                                    {% elif attachement.statut == 'Rejeté' %}bg-red-900 text-red-300
                                    {% else %}bg-gray-700 text-gray-300{% endif %}">
                                    {{ attachement.statut }}
                                </span>
                            </td>
                            <td class="px-2 py-4 whitespace-nowrap montant-cell">
                                {{ attachement.total_montant_ht|format_quantity }}
                            </td>
                            <td class="px-2 py-4"> 
                                {% if attachement.fichier %}
                                <a href="{% url 'projets:download_document' 'Attachement' attachement.id %}?download=true" 
                                    class="text-cyan-400 hover:text-cyan-300 transition inline-flex items-center"
                                    target="_blank"><i class="fa-solid fa-download mr-2"></i> 
                                    <span class="truncate overflow-ellipsis overflow-hidden">{{ attachement.get_file_name }}</span>
                                </a>
                                <a href="{% url 'projets:download_document' 'Attachement' attachement.id %}?download=false" 
                                    class="text-cyan-400 hover:text-cyan-300 transition inline-flex items-center"
                                    target="_blank"><i class="fa-solid fa-eye mr-2"></i> 
                                </a> 
                                {% else %}
                                    <span class="text-gray-400 italic">Aucun fichier</span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-4 text-center space-x-1">
                                <!-- Actions -->

                                <!-- Voir le detail -->
                                <a href="{% url 'projets:detail_attachement' attachement.id %}" 
                                class="mr-2 text-cyan-400 hover:text-cyan-300 transition inline-flex items-center"
                                title="Voir le detail de cet attachement">
                                    <i class="fa-solid fa-eye"></i> 
                                </a>
                                <!-- Modifier -->
                                <a href="{% url 'projets:modifier_attachement' attachement.id %}" 
                                   class="mr-1 text-green-400 hover:text-green-300 transition inline-flex items-center"
                                   title="Modifier cet attachement">
                                    <i class="fa-solid fa-edit"></i> 
                                </a>
                                <!-- Supprimer -->
                                <button onclick="openDeleteModal({{ attachement.id }}, '{{ attachement.numero }}')" 
                                      class="mr-1 text-red-400 hover:text-red-300 transition inline-flex items-center"
                                        title="Supprimer cet attachement">
                                    <i class="fa-solid fa-trash"></i> 
                                </button>
                                {% if attachement.decompte %}
                                <!-- Modifier le décompte -->
                                <a href="{% url 'projets:liste_decomptes' projet.id %}?from_attachements=true&attachement_id={{ attachement.id }}&action=modifier&modifier={{ attachement.decompte.id }}" 
                                    class="mr-1 text-yellow-400 hover:text-yellow-300 transition inline-flex items-center"
                                    title="Modifier le décompte">
                                    <i class="fa-solid fa-edit"></i> 
                                </a>
                                {% else %}
                                <!-- Ajouter un décompte -->
                                <a href="{% url 'projets:liste_decomptes' projet.id %}?from_attachements=true&attachement_id={{ attachement.id }}&action=ajouter" 
                                    class="text-yellow-400 hover:text-yellow-300 transition inline-flex items-center" 
                                    title="Ajouter un décompte">
                                    <i class="fa-solid fa-plus"></i> 
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center">
                <div class="text-cyan-400 text-lg mb-2">
                    <i class="fa-solid fa-folder-open text-4xl mb-4"></i>
                </div>
                <p class="text-[#AECBD6]">Aucun attachement pour ce projet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modale de suppression -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#3B3B3B] border border-[#4B5563] rounded-lg p-6 mx-4 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-red-400 mb-2">Confirmer la suppression</h2>
                <p class="text-[#AECBD6]">
                    Voulez-vous vraiment supprimer l'attachement <strong id="attachementNumero"></strong> ?
                </p>
            </div>

            <div class="bg-red-900/50 border border-red-700 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-circle text-red-400 mt-1"></i>
                    <p class="text-red-200 text-sm">
                        Cette action est irréversible. Toutes les données associées seront perdues.
                    </p>
                </div>
            </div>

            <form id="deleteForm" method="POST" action="">
                {% csrf_token %}
                <div class="flex gap-3">
                    <!-- Bouton de suppression -->
                    <button type="submit" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-trash"></i>
                        Supprimer
                    </button>
                    <button type="button" 
                            onclick="closeDeleteModal()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Fonctions pour gérer la modale de suppression -->
<script>
    let currentAttachementId = null;
    let currentAttachementNumero = null;
    
    function openDeleteModal(attachementId, attachementNumero) {
        currentAttachementId = attachementId;
        currentAttachementNumero = attachementNumero;
        const modal = document.getElementById('deleteModal');
        const form = document.getElementById('deleteForm');
        const numeroElement = document.getElementById('attachementNumero');
        
        // Mettre à jour le numéro de l'attachement dans le message
        numeroElement.textContent = attachementNumero;
        
        // Mettre à jour l'action du formulaire
        form.action = "{% url 'projets:supprimer_attachement' 0 %}".replace('0', attachementId);
        
        // Afficher la modale
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Empêcher le défilement
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Rétablir le défilement
        currentAttachementId = null;
        currentAttachementNumero = null;
    }

    // Fermer la modale en cliquant à l'extérieur
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target.id === 'deleteModal') {
            closeDeleteModal();
        }
    });

    // Fermer avec la touche Échap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });

    // Empêcher la fermeture en cliquant à l'intérieur du contenu
    document.querySelector('#deleteModal > div').addEventListener('click', function(e) {
        e.stopPropagation();
    });
</script>
    <!-- Scripts pour la recherche et le tri -->
    <script>
        // Configuration du tri
        let currentSort = { field: null, direction: 'asc' };

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            updateSortIndicator();
        }

        function updateSortIndicator() {
            document.querySelectorAll('.sortable').forEach(el => {
                el.classList.remove('active');
            });
            
            if (currentSort.field) {
                const activeHeader = document.querySelector(`[data-sort="${currentSort.field}"]`);
                if (activeHeader) {
                    activeHeader.classList.add('active');
                }
            }
        }

        // Configuration de la recherche
        let searchTimeout = null;
        let currentSearchTerm = '';

        const searchToggle = document.getElementById('searchToggle');
        const searchBox = document.getElementById('searchBox');
        const searchInput = document.getElementById('searchInput');
        const resultCount = document.getElementById('resultCount');
        const countValue = document.getElementById('countValue');
        const searchInfo = document.getElementById('searchInfo');
        const searchTerm = document.getElementById('searchTerm');
        const clearSearch = document.getElementById('clearSearch');

        // Toggle de la boîte de recherche
        searchToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            searchBox.classList.toggle('hidden');
            searchBox.classList.toggle('show');
            
            if (!searchBox.classList.contains('hidden')) {
                setTimeout(() => searchInput.focus(), 100);
            }
        });

        // Recherche en temps réel
        searchInput.addEventListener('input', function() {
            const term = this.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                if (term.length >= 3 || term.length === 0) {
                    performSearch(term);
                }
            }, 500);
        });

        // Fermer la boîte de recherche en cliquant à l'extérieur
        document.addEventListener('click', function(e) {
            if (!searchBox.contains(e.target) && !searchToggle.contains(e.target)) {
                searchBox.classList.add('hidden');
                searchBox.classList.remove('show');
            }
        });

        // Recherche avec la touche Entrée
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch(this.value.trim());
            }
        });

        // Effacer la recherche
        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            performSearch('');
            searchInput.focus();
        });

        function performSearch(term) {
            currentSearchTerm = term;
            
            if (term.length >= 3) {
                // Recherche côté client (simulation)
                const rows = document.querySelectorAll('tbody tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(term.toLowerCase())) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                updateSearchUI(term, visibleCount);
                highlightSearchTerms(term);
            } else if (term.length === 0) {
                // Reset à la liste complète
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => row.style.display = '');
                updateSearchUI('', false);
            }
        }

        function updateSearchUI(term, count) {
            if (term.length >= 3) {
                searchInfo.classList.remove('hidden');
                searchTerm.textContent = term;
                resultCount.classList.remove('hidden');
                countValue.textContent = count;
            } else {
                searchInfo.classList.add('hidden');
                resultCount.classList.add('hidden');
            }
        }

        function highlightSearchTerms(term) {
            const elements = document.querySelectorAll('td');
            const regex = new RegExp(term, 'gi');
            
            elements.forEach(el => {
                const html = el.innerHTML;
                const highlighted = html.replace(regex, match => 
                    `<span class="search-highlight">${match}</span>`
                );
                el.innerHTML = highlighted;
            });
        }

        // Fermer avec Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchBox.classList.add('hidden');
                searchBox.classList.remove('show');
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateSortIndicator();
            
            // Masquer automatiquement les messages après 5 secondes
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert-auto-dismiss');
                alerts.forEach(alert => {
                    alert.style.display = 'none';
                });
            }, 5000);
        });
    </script>
</body>
</html>