<div class="bg-gray-800 p-4 rounded-lg shadow">
    <!-- Tableau des projets avec largeur minimale garantie -->
    <table class="min-w-full bg-[#2E2E2E] table-min-width">
        <thead class="bg-gray-700 text-[#2B9C62]">
            <tr class="text-left text-m font-medium uppercase">
                <th class="px-6 py-3 sortable" onclick="sortTable('nom')" data-sort="nom">
                    <div>Projet</div>
                    <div class="text-xs text-gray-400">Numéro de marché</div>
                </th>
                <th class="px-6 py-3 sortable" onclick="sortTable('maitre_ouvrage')" data-sort="maitre_ouvrage">
                    <div>Maitre d'ouvrage</div>
                    <div class="text-xs text-gray-400">Entreprise</div>
                </th>
                <th class="px-6 py-3 sortable" onclick="sortTable('montant_total')" data-sort="montant_total">
                    Montant TTC
                </th>
                <th class="px-6 py-3">
                    <div>Décomptes</div>
                    <div class="text-xs text-gray-400">Nb attachements</div>
                </th>
                <th class="px-6 py-3 sortable" onclick="sortTable('localisation')" data-sort="localisation">
                    Localisation
                </th>
                <th class="px-6 py-3 sortable" onclick="sortTable('statut')" data-sort="statut">
                    Statut
                </th>
                <th class="px-6 py-3 sortable" onclick="sortTable('avancement')" data-sort="avancement">
                    <div>Avancement</div>
                    <div class="text-xs text-gray-400">(%) Décomptes</div>
                </th>
                <th class="px-6 py-3 no-print min-w-[140px]">Actions</th>
            </tr>
        </thead>
        <!-- Corps du tableau -->
        <tbody class="bg-gray-800 divide-y divide-green-800">
            {% for projet in projets %}
            <tr class="text-[#AECBD6] hover:bg-[#3B3B3B] transition-colors">
                <td class="px-4 py-3">
                    <div><a href="{% url 'projets:dashboard' projet.id %}" class="text-cyan-500 hover:text-cyan-600 font-medium">{{ projet.nom }}</a></div>
                    <div class="text-xs text-gray-500">{{ projet.numero }}</div>
                </td>
                <td class="px-4 py-3">
                    <div>{{ projet.maitre_ouvrage }}</div>
                    <div class="text-xs text-gray-500">{{ projet.entreprise }}</div>
                </td>
                <td class="px-4 py-3 text-right print-right font-medium">{{ projet.montant_total_formate }}</td>
                <td class="px-4 py-3 text-center">
                    {% if projet.attachements.all %}
                        <div>
                            <a href="{% url 'projets:liste_attachements' projet.id %}" 
                            class="text-cyan-500 hover:text-cyan-600 font-medium text-lg">
                                {{ projet.attachements.count }}
                            </a>
                        </div>
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3">{{ projet.localisation }}</td>
                <td class="px-6 py-3 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-sm font-semibold rounded-full 
                        {% if projet.statut == 'COURS' %}bg-blue-100 text-blue-800
                        {% elif projet.en_retard %}bg-yellow-100 text-yellow-800
                        {% elif projet.statut|upper == 'RECEP' or projet.statut|upper == 'RECEP_DEF' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ projet.get_statut_display }}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden flex-1">
                            <div class="h-3
                                {% if projet.avancement_workflow < 20 %}bg-red-500
                                {% elif projet.avancement_workflow < 40 %}bg-orange-500
                                {% elif projet.avancement_workflow < 60 %}bg-yellow-500
                                {% elif projet.avancement_workflow < 80 %}bg-green-300
                                {% else %}bg-green-600{% endif %}" 
                                style="width: {{ projet.avancement_workflow }}%"> 
                            </div>
                        </div>
                        <span class="text-sm text-[#AECBD6] font-medium min-w-[40px]">{{ projet.avancement_workflow|floatformat:0 }}%</span>
                    </div>
                </td>
                <td class="px-6 py-3 whitespace-nowrap no-print">
                    <div class="flex justify-center items-center space-x-4">
                        <button class="btn-create-notification"
                                data-projet-id="{{ projet.id }}"
                                data-projet-nom="{{ projet.nom }}"
                                title="Créer une notification">
                            <i class="fas fa-bell text-lg"></i>
                        </button>
                        {% if can_handler %}
                        <button onclick="charger_modal('{% url 'projets:modifier_projet_modal' projet.id %}')" 
                            class="text-green-600 hover:text-green-900 p-2 bg-green-50 hover:bg-green-100 rounded-lg transition-colors"
                            title="Voir/modifier le projet">
                            <i class="fas fa-eye text-lg"></i>
                        </button>
                        <a href="{% url 'projets:supprimer_projet' projet.id %}" 
                           onclick="supprimerProjet(event, this)"
                           class="text-red-600 hover:text-red-900 p-2 bg-red-50 hover:bg-red-100 rounded-lg transition-colors inline-flex"
                           title="Supprimer le projet">
                            <i class="fas fa-trash-alt text-lg"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-[#AECBD6] text-lg">
                    <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-inbox text-4xl text-gray-500 mb-3"></i>
                        <p class="font-medium">Aucun projet disponible</p>
                        <p class="text-sm text-gray-400 mt-1">Cliquez sur "Ajouter un projet" pour commencer</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function supprimerProjet(event, element) {
        event.preventDefault();
        if (confirm('Supprimer ce projet ?')) {
            fetch(element.href, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    htmx.ajax('GET', "{% url 'projets:liste_projets' %}", {
                       target: "#liste_projets",
                       swap: "innerHTML"
                    });
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-create-notification').forEach(button => {
            button.addEventListener('click', function() {
                const projetId = this.dataset.projetId;
                const projetNom = this.dataset.projetNom;
                openNotificationModal(projetId, projetNom);
            });
        });
    });
</script>